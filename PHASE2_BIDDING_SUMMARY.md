# ğŸ² æŠ¢åœ°ä¸»åŠŸèƒ½å®ç°æ€»ç»“ - é˜¶æ®µ2

**å®æ–½æ—¥æœŸ**: 2025-10-26  
**å®æ–½æ—¶é—´**: 11:30 - 12:00  
**çŠ¶æ€**: âœ… é˜¶æ®µ2å®Œæˆ

---

## ğŸ“‹ å®ç°å†…å®¹

### **æ ¸å¿ƒåŠŸèƒ½**

#### **1. æŠ¢åœ°ä¸»æµç¨‹** âœ…
- âœ… éšæœºé€‰æ‹©ç¬¬ä¸€ä¸ªæŠ¢åœ°ä¸»çš„ç©å®¶
- âœ… é¡ºæ—¶é’ˆè½®æµæŠ¢åœ°ä¸»
- âœ… ç©å®¶å¯é€‰æ‹©"æŠ¢"æˆ–"ä¸æŠ¢"
- âœ… è®°å½•æ‰€æœ‰ç©å®¶çš„æŠ¢åœ°ä¸»å†³å®š

#### **2. åœ°ä¸»ç¡®å®šé€»è¾‘** âœ…
- âœ… æœ€åä¸€ä¸ªé€‰æ‹©"æŠ¢"çš„ç©å®¶æˆä¸ºåœ°ä¸»
- âœ… å¦‚æœæ²¡æœ‰äººæŠ¢ï¼Œé‡æ–°å‘ç‰Œ
- âœ… åœ°ä¸»è·å¾—3å¼ åº•ç‰Œ
- âœ… åº•ç‰ŒåŠ å…¥åœ°ä¸»æ‰‹ç‰Œå¹¶é‡æ–°æ’åº

#### **3. è§’è‰²åˆ†é…** âœ…
- âœ… è®¾ç½®åœ°ä¸»è§’è‰²ï¼ˆlandlordï¼‰
- âœ… è®¾ç½®å†œæ°‘è§’è‰²ï¼ˆfarmerï¼‰
- âœ… åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€ï¼ˆåœ°ä¸»å…ˆå‡ºç‰Œï¼‰

#### **4. äº‹ä»¶é€šçŸ¥** âœ…
- âœ… é€šçŸ¥æ‰€æœ‰ç©å®¶å¼€å§‹æŠ¢åœ°ä¸»
- âœ… å¹¿æ’­æ¯ä¸ªç©å®¶çš„æŠ¢åœ°ä¸»å†³å®š
- âœ… é€šçŸ¥åœ°ä¸»ç¡®å®šç»“æœ
- âœ… å•ç‹¬é€šçŸ¥åœ°ä¸»æ›´æ–°åçš„æ‰‹ç‰Œ
- âœ… é€šçŸ¥åœ°ä¸»å…ˆå‡ºç‰Œ

---

## ğŸ”§ æŠ€æœ¯å®ç°

### **åç«¯å®ç°**

#### **GameFlowHandler.ts - æ–°å¢æ–¹æ³•**

```typescript
/**
 * å¼€å§‹æŠ¢åœ°ä¸»æµç¨‹
 */
private startBidding(roomId: string): void {
  // 1. éšæœºé€‰æ‹©ç¬¬ä¸€ä¸ªæŠ¢åœ°ä¸»çš„ç©å®¶
  const firstBidderIndex = Math.floor(Math.random() * 3);
  
  // 2. åˆå§‹åŒ–æŠ¢åœ°ä¸»çŠ¶æ€
  room.biddingState = {
    currentBidderId: firstBidderId,
    bids: [],
    landlordId: null,
    biddingOrder: [...]
  };
  
  // 3. é€šçŸ¥æ‰€æœ‰ç©å®¶å¼€å§‹æŠ¢åœ°ä¸»
  this.io.to(`room_${roomId}`).emit('bidding_start', {...});
}

/**
 * å¤„ç†æŠ¢åœ°ä¸»
 */
public handleBidLandlord(roomId: string, userId: string, bid: boolean): void {
  // 1. éªŒè¯æ˜¯å¦è½®åˆ°è¯¥ç©å®¶
  // 2. è®°å½•æŠ¢åœ°ä¸»ç»“æœ
  // 3. å¦‚æœé€‰æ‹©æŠ¢ï¼Œè®°å½•ä¸ºæ½œåœ¨åœ°ä¸»
  // 4. å¹¿æ’­æŠ¢åœ°ä¸»ç»“æœ
  // 5. æ£€æŸ¥æ˜¯å¦æ‰€æœ‰äººéƒ½å·²æŠ¢åœ°ä¸»
  // 6. å¦‚æœå®Œæˆï¼Œç¡®å®šåœ°ä¸»ï¼›å¦åˆ™æ›´æ–°ä¸‹ä¸€ä¸ªç©å®¶
}

/**
 * ç¡®å®šåœ°ä¸»
 */
private determineLandlord(roomId: string): void {
  // 1. æ£€æŸ¥æ˜¯å¦æœ‰äººæŠ¢åœ°ä¸»
  // 2. å¦‚æœæ²¡æœ‰äººæŠ¢ï¼Œé‡æ–°å‘ç‰Œ
  // 3. åœ°ä¸»è·å¾—åº•ç‰Œ
  // 4. è®¾ç½®è§’è‰²
  // 5. åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
  // 6. é€šçŸ¥æ‰€æœ‰ç©å®¶
  // 7. é€šçŸ¥åœ°ä¸»å…ˆå‡ºç‰Œ
}
```

#### **SocketEventHandler.ts - æ–°å¢æ–¹æ³•**

```typescript
/**
 * å¤„ç†æŠ¢åœ°ä¸»äº‹ä»¶
 */
public async handleBidLandlord(socket: AuthenticatedSocket, data: any): Promise<void> {
  const { roomId, userId, bid } = data;
  gameFlowHandler.handleBidLandlord(roomId, userId, bid);
}
```

#### **app.ts - æ³¨å†Œäº‹ä»¶**

```typescript
// æ·»åŠ æŠ¢åœ°ä¸»äº‹ä»¶
socket.on('bid_landlord', (data: any) => {
  this.eventHandler.handleBidLandlord(socket, data);
});
```

### **å‰ç«¯å®ç°**

#### **test-game-flow.html - æ–°å¢åŠŸèƒ½**

1. **æŠ¢åœ°ä¸»æŒ‰é’®**
   - æ¯ä¸ªç©å®¶é¢æ¿æ·»åŠ "æŠ¢åœ°ä¸»"å’Œ"ä¸æŠ¢"æŒ‰é’®
   - ç»¿è‰²æŒ‰é’®è¡¨ç¤º"æŠ¢"ï¼Œçº¢è‰²æŒ‰é’®è¡¨ç¤º"ä¸æŠ¢"

2. **äº‹ä»¶ç›‘å¬å™¨**
   ```javascript
   // å¼€å§‹æŠ¢åœ°ä¸»
   socket.on('bidding_start', (data) => {
     log(playerId, `ğŸ² å¼€å§‹æŠ¢åœ°ä¸»! ç¬¬ä¸€ä¸ªç©å®¶: ${data.firstBidderName}`);
     log(playerId, `åº•ç‰Œ: ${data.bottomCards.join(', ')}`);
   });

   // æŠ¢åœ°ä¸»ç»“æœ
   socket.on('bid_result', (data) => {
     const bidText = data.bid ? 'æŠ¢' : 'ä¸æŠ¢';
     log(playerId, `ğŸ² ${data.userName} é€‰æ‹©: ${bidText}`);
   });

   // åœ°ä¸»ç¡®å®š
   socket.on('landlord_determined', (data) => {
     log(playerId, `ğŸ‘‘ åœ°ä¸»ç¡®å®š: ${data.landlordName}`);
     const role = data.roles[player.name];
     log(playerId, `ä½ çš„è§’è‰²: ${role === 'landlord' ? 'åœ°ä¸»' : 'å†œæ°‘'}`);
   });

   // åœ°ä¸»è·å¾—åº•ç‰Œ
   socket.on('landlord_cards_update', (data) => {
     log(playerId, `ğŸ‘‘ åœ°ä¸»è·å¾—åº•ç‰Œï¼Œç°åœ¨æœ‰ ${data.cardCount} å¼ ç‰Œ`);
   });

   // è½®åˆ°å‡ºç‰Œ
   socket.on('turn_to_play', (data) => {
     log(playerId, `ğŸ¯ è½®åˆ° ${data.playerName} å‡ºç‰Œ`);
   });
   ```

3. **æŠ¢åœ°ä¸»å‡½æ•°**
   ```javascript
   function bidLandlord(playerId, bid) {
     const bidText = bid ? 'æŠ¢åœ°ä¸»' : 'ä¸æŠ¢';
     log(playerId, `å‘é€æŠ¢åœ°ä¸»å†³å®š: ${bidText}`);
     player.socket.emit('bid_landlord', {
       roomId: player.room,
       userId: player.name,
       bid: bid
     });
   }
   ```

4. **è‡ªåŠ¨æµ‹è¯•é˜¶æ®µ6**
   ```javascript
   async function testPhase6() {
     console.log('ğŸ¯ å¼€å§‹é˜¶æ®µ6: æŠ¢åœ°ä¸»');
     await sleep(3000);
     
     // æ¨¡æ‹ŸæŠ¢åœ°ä¸»ï¼šplayer1æŠ¢ï¼Œå…¶ä»–ä¸æŠ¢
     bidLandlord(1, true);
     await sleep(1000);
     bidLandlord(2, false);
     await sleep(1000);
     bidLandlord(3, false);
   }
   ```

---

## ğŸ“¡ äº‹ä»¶æµç¨‹

### **å®Œæ•´çš„æŠ¢åœ°ä¸»äº‹ä»¶æµ**

```
1. æ¸¸æˆå¼€å§‹å¹¶å‘ç‰Œ
   â†“
2. å»¶è¿Ÿ2ç§’åè‡ªåŠ¨å¼€å§‹æŠ¢åœ°ä¸»
   â†“
3. æœåŠ¡å™¨ â†’ æ‰€æœ‰ç©å®¶: bidding_start
   - firstBidderId: ç¬¬ä¸€ä¸ªæŠ¢åœ°ä¸»çš„ç©å®¶ID
   - firstBidderName: ç©å®¶åç§°
   - bottomCards: åº•ç‰Œï¼ˆæ˜¾ç¤ºä½†ä¸åˆ†é…ï¼‰
   â†“
4. ç©å®¶1 â†’ æœåŠ¡å™¨: bid_landlord { bid: true/false }
   â†“
5. æœåŠ¡å™¨ â†’ æ‰€æœ‰ç©å®¶: bid_result
   - userId: ç©å®¶ID
   - userName: ç©å®¶åç§°
   - bid: æŠ¢/ä¸æŠ¢
   - nextBidderId: ä¸‹ä¸€ä¸ªç©å®¶ID
   â†“
6. ç©å®¶2 â†’ æœåŠ¡å™¨: bid_landlord { bid: true/false }
   â†“
7. æœåŠ¡å™¨ â†’ æ‰€æœ‰ç©å®¶: bid_result
   â†“
8. ç©å®¶3 â†’ æœåŠ¡å™¨: bid_landlord { bid: true/false }
   â†“
9. æœåŠ¡å™¨ â†’ æ‰€æœ‰ç©å®¶: bid_result (nextBidderId: null)
   â†“
10. æœåŠ¡å™¨ â†’ æ‰€æœ‰ç©å®¶: landlord_determined
    - landlordId: åœ°ä¸»ID
    - landlordName: åœ°ä¸»åç§°
    - bottomCards: åº•ç‰Œ
    - roles: { [userId]: 'landlord' | 'farmer' }
    â†“
11. æœåŠ¡å™¨ â†’ åœ°ä¸»: landlord_cards_update
    - cards: æ›´æ–°åçš„æ‰‹ç‰Œï¼ˆåŒ…å«åº•ç‰Œï¼‰
    - cardCount: ç‰Œæ•°ï¼ˆ20å¼ ï¼‰
    â†“
12. å»¶è¿Ÿ2ç§’å
    â†“
13. æœåŠ¡å™¨ â†’ æ‰€æœ‰ç©å®¶: turn_to_play
    - playerId: åœ°ä¸»ID
    - playerName: åœ°ä¸»åç§°
    - isFirst: true
```

---

## ğŸ¯ å…³é”®æ•°æ®ç»“æ„

### **æˆ¿é—´æŠ¢åœ°ä¸»çŠ¶æ€**

```typescript
room.biddingState = {
  currentBidderId: string,      // å½“å‰æŠ¢åœ°ä¸»çš„ç©å®¶ID
  bids: Array<{                 // æ‰€æœ‰ç©å®¶çš„æŠ¢åœ°ä¸»è®°å½•
    userId: string,
    bid: boolean
  }>,
  landlordId: string | null,    // åœ°ä¸»IDï¼ˆæœ€åä¸€ä¸ªæŠ¢çš„ç©å®¶ï¼‰
  biddingOrder: string[]        // æŠ¢åœ°ä¸»é¡ºåº
}
```

### **æˆ¿é—´æ¸¸æˆçŠ¶æ€**

```typescript
room.gameState = {
  landlordId: string,           // åœ°ä¸»ID
  currentPlayerId: string,      // å½“å‰å‡ºç‰Œç©å®¶IDï¼ˆåˆå§‹ä¸ºåœ°ä¸»ï¼‰
  lastPlayedCards: null,        // æœ€åå‡ºçš„ç‰Œ
  lastPlayerId: null            // æœ€åå‡ºç‰Œçš„ç©å®¶ID
}
```

### **ç©å®¶è§’è‰²**

```typescript
player.role = 'landlord' | 'farmer'
```

---

## âœ… æµ‹è¯•éªŒè¯

### **æµ‹è¯•æ­¥éª¤**

1. å¯åŠ¨åç«¯æœåŠ¡å™¨
   ```bash
   npm run dev
   ```

2. è®¿é—®æµ‹è¯•å·¥å…·
   ```
   http://localhost:3000/test-game-flow.html
   ```

3. æ‰§è¡Œæµ‹è¯•æµç¨‹
   - ç‚¹å‡»"é˜¶æ®µ1: ä¸‰äººç™»å½•"
   - ç‚¹å‡»"é˜¶æ®µ2: è¿›å…¥å¤§å…"
   - ç‚¹å‡»"é˜¶æ®µ3: åŠ å…¥æˆ¿é—´A01"
   - ç‚¹å‡»"é˜¶æ®µ4: å…¨éƒ¨å‡†å¤‡"
   - ç­‰å¾…è‡ªåŠ¨å‘ç‰Œï¼ˆé˜¶æ®µ5ï¼‰
   - ç‚¹å‡»"é˜¶æ®µ6: æŠ¢åœ°ä¸»"

### **é¢„æœŸç»“æœ**

âœ… æ‰€æœ‰ç©å®¶æ”¶åˆ°`bidding_start`äº‹ä»¶  
âœ… æ˜¾ç¤ºç¬¬ä¸€ä¸ªæŠ¢åœ°ä¸»çš„ç©å®¶  
âœ… æ˜¾ç¤ºåº•ç‰Œ  
âœ… æ¯ä¸ªç©å®¶çš„æŠ¢åœ°ä¸»å†³å®šè¢«å¹¿æ’­  
âœ… åœ°ä¸»è¢«æ­£ç¡®ç¡®å®š  
âœ… åœ°ä¸»è·å¾—åº•ç‰Œï¼ˆ20å¼ ï¼‰  
âœ… å†œæ°‘ä¿æŒ17å¼ ç‰Œ  
âœ… æ‰€æœ‰ç©å®¶æ”¶åˆ°è§’è‰²ä¿¡æ¯  
âœ… é€šçŸ¥åœ°ä¸»å…ˆå‡ºç‰Œ  

---

## ğŸ› å·²ä¿®å¤çš„é—®é¢˜

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ | çŠ¶æ€ |
|------|---------|------|
| ç¼ºå°‘æŠ¢åœ°ä¸»åŠŸèƒ½ | å®ç°`GameFlowHandler`ä¸­çš„æŠ¢åœ°ä¸»æ–¹æ³• | âœ… |
| ç¼ºå°‘`bid_landlord`äº‹ä»¶å¤„ç† | åœ¨`SocketEventHandler`ä¸­æ·»åŠ å¤„ç†æ–¹æ³• | âœ… |
| ç¼ºå°‘`bid_landlord`äº‹ä»¶æ³¨å†Œ | åœ¨`app.ts`ä¸­æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ | âœ… |
| TypeScriptç±»å‹é”™è¯¯ | ä½¿ç”¨`any`ç±»å‹ä¸´æ—¶ç»•è¿‡ï¼ˆå¾…ä¼˜åŒ–ï¼‰ | âœ… |
| æµ‹è¯•å·¥å…·ç¼ºå°‘æŠ¢åœ°ä¸»UI | æ·»åŠ æŠ¢åœ°ä¸»æŒ‰é’®å’Œäº‹ä»¶ç›‘å¬å™¨ | âœ… |

---

## ğŸ“ å¾…ä¼˜åŒ–é¡¹

1. **ç±»å‹å®šä¹‰ä¼˜åŒ–**
   - ä¸º`GameRoom`æ·»åŠ `biddingState`ã€`gameState`ã€`bottomCards`ç­‰å±æ€§çš„ç±»å‹å®šä¹‰
   - ç§»é™¤ä¸´æ—¶çš„`any`ç±»å‹è½¬æ¢

2. **æŠ¢åœ°ä¸»è§„åˆ™æ‰©å±•**
   - æ”¯æŒ"å«åœ°ä¸»"ï¼ˆ1åˆ†ã€2åˆ†ã€3åˆ†ï¼‰
   - æ”¯æŒ"åŠ å€"åŠŸèƒ½
   - æ”¯æŒ"æ˜ç‰Œ"åŠŸèƒ½

3. **é”™è¯¯å¤„ç†**
   - æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯æç¤º
   - å¤„ç†ç½‘ç»œæ–­çº¿é‡è¿æƒ…å†µ

4. **UIä¼˜åŒ–**
   - åœ¨æµ‹è¯•å·¥å…·ä¸­æ˜¾ç¤ºå½“å‰è½®åˆ°è°æŠ¢åœ°ä¸»
   - é«˜äº®æ˜¾ç¤ºå½“å‰ç©å®¶
   - ç¦ç”¨éå½“å‰ç©å®¶çš„æŒ‰é’®

---

## ğŸŠ æˆæœ

âœ… **æŠ¢åœ°ä¸»åŠŸèƒ½å®Œæ•´å®ç°**  
âœ… **å‰åç«¯äº‹ä»¶é€šä¿¡æ­£å¸¸**  
âœ… **æµ‹è¯•å·¥å…·æ”¯æŒæŠ¢åœ°ä¸»é˜¶æ®µ**  
âœ… **æ¸¸æˆæµç¨‹è¿›åº¦ï¼š75%**  

---

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’

### **é˜¶æ®µ3: å‡ºç‰Œé€»è¾‘**

1. **ç‰Œå‹è¯†åˆ«**
   - å•å¼ ã€å¯¹å­ã€ä¸‰å¼ 
   - é¡ºå­ã€è¿å¯¹ã€é£æœº
   - ç‚¸å¼¹ã€ç‹ç‚¸

2. **ç‰Œå‹æ¯”è¾ƒ**
   - ç›¸åŒç‰Œå‹å¤§å°æ¯”è¾ƒ
   - ç‚¸å¼¹å‹ç‰Œè§„åˆ™

3. **å‡ºç‰ŒéªŒè¯**
   - éªŒè¯ç©å®¶æ˜¯å¦æœ‰è¿™äº›ç‰Œ
   - éªŒè¯ç‰Œå‹æ˜¯å¦åˆæ³•
   - éªŒè¯æ˜¯å¦èƒ½å‹è¿‡ä¸Šå®¶

4. **æ¸¸æˆç»“æŸ**
   - æ£€æµ‹ç©å®¶æ‰‹ç‰Œä¸ºç©º
   - è®¡ç®—èƒœè´Ÿ
   - ç»“ç®—ç§¯åˆ†

---

**å‡†å¤‡å¼€å§‹å®ç°å‡ºç‰Œé€»è¾‘ï¼** ğŸ¯
