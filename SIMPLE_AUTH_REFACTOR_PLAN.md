# 🔐 极简认证系统改造计划

**目标**: 实现最简单的一次性认证，专注于游戏功能开发和调试

**日期**: 2025年10月25日  
**备份提交**: ✅ 已完成 (commit: 备份：简化认证系统前的代码状态)

---

## 📋 改造原则

### **核心思路**
1. **Login时认证一次** - 用户登录时验证用户名，创建会话
2. **全局状态保持** - 认证状态在整个应用生命周期保持
3. **无重复验证** - Lobby和Room页面不再验证，直接使用认证状态
4. **专注功能开发** - 简化认证逻辑，专注于游戏核心功能

### **认证流程**
```
Login页面
  ↓
输入用户名 → 连接Socket → 自动认证 → 保存状态
  ↓
跳转到Lobby（携带用户信息）
  ↓
Lobby页面（无需认证，直接使用状态）
  ↓
加入房间 → 跳转到Room
  ↓
Room页面（无需认证，直接使用状态）
  ↓
游戏功能（发牌、抢地主、出牌等）
```

---

## 🎯 改造步骤

### **Phase 1: 清理认证中间件** ✅
**目标**: 简化AuthMiddleware，只保留基本的用户创建和会话管理

**修改文件**:
- `backend/src/middleware/AuthMiddleware.ts`

**改造内容**:
1. 保留 `authenticateByUserId` - 自动创建用户
2. 删除所有注释掉的代码
3. 简化错误处理
4. 移除复杂的权限检查

### **Phase 2: 简化前端认证流程** ✅
**目标**: Login时认证，后续页面直接使用状态

**修改文件**:
- `frontend/public/login/js/login.js`
- `frontend/public/js/global-socket.js`
- `frontend/public/lobby/js/lobby.js`
- `frontend/public/room/js/room.js`

**改造内容**:
1. Login: 连接Socket → 自动认证 → 跳转Lobby
2. GlobalSocket: 简化连接逻辑，保持单连接
3. Lobby: 移除认证检查，直接使用URL参数
4. Room: 移除认证检查，直接使用URL参数

### **Phase 3: 统一房间服务** ✅
**目标**: 删除gameRoomsService，统一使用roomService

**修改文件**:
- `backend/src/services/socket/SocketEventHandler.ts`
- `backend/src/app.ts`

**改造内容**:
1. 删除gameRoomsService的引用
2. 统一使用roomService管理房间
3. 确保数据一致性

### **Phase 4: 实现游戏核心功能** 🔄
**目标**: 实现发牌、抢地主、出牌等核心功能

**功能列表**:
1. ✅ 加入房间
2. ✅ 玩家准备
3. 🔄 开始游戏（发牌）
4. 🔄 抢地主
5. 🔄 出牌
6. 🔄 游戏结算

---

## 📝 修改日志

### **2025-10-25 22:40 - 代码备份**
- ✅ Git提交所有当前代码
- ✅ 创建改造计划文档

### **接下来的步骤**
1. Phase 1: 清理AuthMiddleware
2. Phase 2: 简化前端认证
3. Phase 3: 统一房间服务
4. Phase 4: 实现游戏功能
5. 测试完整流程

---

## 🎮 游戏功能开发计划

### **核心功能优先级**

#### **P0 - 必须功能**
1. ✅ 用户登录
2. ✅ 房间列表
3. ✅ 加入房间
4. ✅ 玩家准备
5. 🔄 开始游戏
6. 🔄 发牌（17+17+17+3）
7. 🔄 抢地主
8. 🔄 出牌
9. 🔄 游戏结算

#### **P1 - 重要功能**
- 聊天系统
- 房间状态同步
- 玩家离开处理
- 断线重连

#### **P2 - 优化功能**
- 游戏历史
- 玩家统计
- 房间管理
- 权限控制

---

## 🧪 测试计划

### **测试流程**
1. **登录测试** - 多个用户登录
2. **房间测试** - 创建、加入、离开房间
3. **游戏测试** - 完整游戏流程
4. **异常测试** - 断线、错误操作等

### **测试用例**
- [ ] 用户A登录 → 进入大厅 → 查看房间列表
- [ ] 用户A加入房间1 → 准备
- [ ] 用户B登录 → 加入房间1 → 准备
- [ ] 用户C登录 → 加入房间1 → 准备
- [ ] 3人准备 → 开始游戏 → 发牌
- [ ] 抢地主流程
- [ ] 出牌流程
- [ ] 游戏结算

---

## 📊 进度跟踪

| 阶段 | 状态 | 完成时间 |
|------|------|---------|
| 代码备份 | ✅ 完成 | 2025-10-25 22:40 |
| Phase 1 | 🔄 进行中 | - |
| Phase 2 | ⏳ 待开始 | - |
| Phase 3 | ⏳ 待开始 | - |
| Phase 4 | ⏳ 待开始 | - |
| 测试验证 | ⏳ 待开始 | - |

---

**准备开始Phase 1改造！** 🚀
