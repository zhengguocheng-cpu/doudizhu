# 🎲 抢地主功能测试指南

**测试日期**: 2025-10-26  
**测试版本**: v0.6.0  
**测试目标**: 验证抢地主功能的完整流程

---

## 📋 测试前准备

### **1. 启动后端服务器**

```bash
cd e:\windsurf_prj\doudizhu\backend
npm run dev
```

**预期输出**:
```
🚀 斗地主游戏服务器启动成功
📍 服务器地址: http://localhost:3000
```

### **2. 打开测试工具**

在浏览器中打开：
```
http://localhost:3000/test-game-flow.html
```

---

## 🧪 测试流程

### **阶段1-5: 准备工作** ✅

这些阶段已经在之前测试过，快速执行：

1. **点击"阶段1: 三人登录"**
   - 等待3秒，确保所有玩家连接成功
   - 每个玩家面板应显示"已连接"

2. **点击"阶段2: 进入大厅"**
   - 自动完成（登录时已进入大厅）

3. **点击"阶段3: 加入房间A01"**
   - 等待3秒，确保所有玩家加入房间
   - 每个玩家面板应显示"房间: A01"

4. **点击"阶段4: 全部准备"**
   - 等待2秒，确保所有玩家准备完毕
   - 日志应显示"玩家准备"消息

5. **等待自动发牌（阶段5）**
   - 游戏会在所有玩家准备后自动开始
   - 每个玩家应收到17张牌
   - 日志应显示"🎴 收到牌: 17张"
   - 日志应显示"底牌: 3张"

---

### **阶段6: 抢地主测试** 🎯

#### **测试场景1: 自动测试（推荐）**

1. **点击"阶段6: 抢地主"按钮**

2. **观察日志输出**

   **所有玩家应看到**:
   ```
   🎲 开始抢地主! 第一个玩家: player1/player2/player3
   底牌: ♠3, ♥5, ♦K (示例)
   ```

3. **自动执行抢地主**
   - 脚本会自动模拟：player1抢，player2不抢，player3不抢
   - 观察每个玩家的日志

4. **验证抢地主过程**

   **每个玩家应看到**:
   ```
   🎲 player1 选择: 抢
   下一个: player2
   
   🎲 player2 选择: 不抢
   下一个: player3
   
   🎲 player3 选择: 不抢
   ```

5. **验证地主确定**

   **所有玩家应看到**:
   ```
   👑 地主确定: player1
   底牌: ♠3, ♥5, ♦K
   你的角色: 地主/农民
   ```

6. **验证地主获得底牌**

   **地主（player1）应额外看到**:
   ```
   👑 地主获得底牌，现在有 20 张牌
   ```

7. **验证出牌通知**

   **所有玩家应看到**:
   ```
   🎯 轮到 player1 出牌
   ```

---

#### **测试场景2: 手动测试**

1. **完成阶段1-5**

2. **等待抢地主开始**
   - 发牌后2秒自动开始抢地主
   - 观察哪个玩家是第一个抢地主的

3. **手动点击抢地主按钮**
   - 根据日志提示，点击对应玩家的"抢地主"或"不抢"按钮
   - 按照顺序依次操作

4. **观察结果**
   - 验证地主是否正确确定
   - 验证底牌是否正确分配

---

#### **测试场景3: 没有人抢地主**

1. **完成阶段1-5**

2. **等待抢地主开始**

3. **所有玩家都点击"不抢"**
   - Player1: 点击"不抢"
   - Player2: 点击"不抢"
   - Player3: 点击"不抢"

4. **验证重新发牌**

   **所有玩家应看到**:
   ```
   ❌ 没有人抢地主，重新发牌
   ```

5. **验证游戏重新开始**
   - 2秒后应重新发牌
   - 重新开始抢地主流程

---

## ✅ 验证清单

### **基本功能验证**

- [ ] 所有玩家收到`bidding_start`事件
- [ ] 第一个抢地主的玩家是随机的
- [ ] 底牌正确显示（3张）
- [ ] 抢地主顺序正确（顺时针）
- [ ] 每个玩家的决定被正确广播
- [ ] 地主被正确确定（最后一个抢的玩家）
- [ ] 地主获得底牌（总共20张）
- [ ] 农民保持17张牌
- [ ] 角色正确分配（1个地主，2个农民）
- [ ] 通知地主先出牌

### **边界情况验证**

- [ ] 没有人抢地主时重新发牌
- [ ] 只有一个人抢地主
- [ ] 所有人都抢地主（最后一个成为地主）
- [ ] 第一个玩家抢地主
- [ ] 最后一个玩家抢地主

### **UI验证**

- [ ] 日志正确显示所有事件
- [ ] 底牌正确显示
- [ ] 角色信息正确显示
- [ ] 按钮可正常点击
- [ ] 没有JavaScript错误

---

## 🐛 常见问题排查

### **问题1: 没有收到抢地主事件**

**可能原因**:
- 后端服务器未启动
- Socket连接断开
- 事件监听器未正确注册

**解决方案**:
1. 检查后端服务器是否运行
2. 刷新页面重新连接
3. 查看浏览器控制台是否有错误

---

### **问题2: 点击按钮没有反应**

**可能原因**:
- 玩家未加入房间
- 不是该玩家的回合
- Socket连接断开

**解决方案**:
1. 确保玩家已加入房间（房间信息显示"房间: A01"）
2. 确保按照顺序点击
3. 检查日志是否显示"下一个: playerX"

---

### **问题3: 地主没有获得底牌**

**可能原因**:
- 事件监听器未正确处理
- 后端逻辑错误

**解决方案**:
1. 查看后端日志
2. 检查`landlord_cards_update`事件是否发送
3. 查看浏览器控制台是否有错误

---

### **问题4: 重新发牌不工作**

**可能原因**:
- 延迟时间未到
- 游戏状态未正确重置

**解决方案**:
1. 等待2秒
2. 查看后端日志
3. 如果仍然不工作，点击"重置所有"重新开始

---

## 📊 测试结果记录

### **测试环境**

- 操作系统: Windows
- 浏览器: Chrome/Edge/Firefox
- Node.js版本: v18+
- 后端版本: v0.6.0

### **测试结果**

| 测试项 | 预期结果 | 实际结果 | 状态 |
|--------|---------|---------|------|
| 开始抢地主 | 收到bidding_start事件 | | ⏳ |
| 第一个玩家随机 | 每次不同 | | ⏳ |
| 抢地主顺序 | 顺时针轮流 | | ⏳ |
| 地主确定 | 最后一个抢的玩家 | | ⏳ |
| 地主获得底牌 | 20张牌 | | ⏳ |
| 农民手牌 | 17张牌 | | ⏳ |
| 角色分配 | 1地主2农民 | | ⏳ |
| 没有人抢 | 重新发牌 | | ⏳ |
| 通知出牌 | 地主先出 | | ⏳ |

---

## 🎯 测试通过标准

✅ **所有验证清单项都通过**  
✅ **没有JavaScript错误**  
✅ **没有后端错误**  
✅ **所有测试场景都正常工作**  
✅ **UI显示正确**  

---

## 📝 测试报告模板

```markdown
# 抢地主功能测试报告

**测试人员**: [你的名字]
**测试日期**: 2025-10-26
**测试时间**: [开始时间] - [结束时间]

## 测试结果

- 总测试项: 19
- 通过: [数量]
- 失败: [数量]
- 跳过: [数量]

## 发现的问题

1. [问题描述]
   - 严重度: 高/中/低
   - 复现步骤: ...
   - 预期结果: ...
   - 实际结果: ...

## 建议

[你的建议]

## 结论

[测试通过/测试失败]
```

---

**准备开始测试！** 🚀

**提示**: 建议先运行自动测试（测试场景1），然后再尝试手动测试和边界情况测试。
