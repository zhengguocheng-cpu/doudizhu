# 计分系统测试指南

## 🎯 计分系统概述

### 基础规则（当前实现）
- **基础分**: 5000（记为 1 底分，用于所有计分公式）
- **地主获胜**: 地主得分 = 基础分 × 倍数 × 2（从 2 个农民处赢得）
- **农民获胜**: 每个农民得分 = 基础分 × 倍数

### 倍数计算（当前实现）

| 类型 | 倍数 | 说明 |
|------|------|------|
| 炸弹 | ×3^n | n = 炸弹数量；每个炸弹×3，累乘，例如 1 个=×3，2 个=×9，3 个=×27 |
| 王炸 | ×8^n | n = 王炸数量；每个王炸×8，累乘，例如 1 个=×8，2 个=×64 |
| 春天 | ×16 | 地主获胜且农民一张牌都没出 |
| 反春 | ×16 | 农民获胜且地主一张牌都没出 |

**总倍数 = 基础 × 炸弹 × 王炸 × 春天 × 反春（当前基础倍数恒为 1）**

---

## 🧪 测试场景

### 场景1：基础得分（无倍数）

**条件**：
- 正常游戏，无炸弹、无王炸
- 地主或农民正常出完牌

**预期结果**：
- 基础分：5000（1 底分）
- 倍数：×1
- 地主获胜：地主 +基础分×2，农民各 -基础分
- 农民获胜：地主 -基础分×2，农民各 +基础分

**测试步骤**：
1. 开始游戏
2. 正常出牌，避免出炸弹和王炸
3. 某方出完所有牌
4. 查看结算界面

**验证**：
```
✅ 倍数显示：×1
✅ 得分正确：符合「地主 = 基础分 × 倍数 × 2、农民 = ±基础分 × 倍数」公式
✅ 无额外倍数说明
```

---

### 场景2：单个炸弹

**条件**：
- 游戏中出现1个炸弹（4张相同的牌）
- 无其他倍数

**预期结果**：
- 基础分：5000（1 底分）
- 倍数：×3（1 个炸弹，对应炸弹倍数 3）
- 地主获胜：地主 +基础分×倍数×2，农民各 -基础分×倍数
- 农民获胜：地主 -基础分×倍数×2，农民各 +基础分×倍数

**测试步骤**：
1. 开始游戏
2. 出1次炸弹（如：4个7）
3. 某方出完所有牌
4. 查看结算界面

**验证**：
```
✅ 倍数显示：×3 (炸弹×1)
✅ 得分正确：符合通用计分公式
✅ 控制台显示：bombCount: 1
```

---

### 场景3：多个炸弹

**条件**：
- 游戏中出现2个炸弹
- 无其他倍数

**预期结果**：
- 基础分：5000（1 底分）
- 倍数：×9（2 个炸弹，3^2=9）
- 地主获胜：地主 +基础分×倍数×2，农民各 -基础分×倍数
- 农民获胜：地主 -基础分×倍数×2，农民各 +基础分×倍数

**测试步骤**：
1. 开始游戏
2. 出2次炸弹
3. 某方出完所有牌
4. 查看结算界面

**验证**：
```
✅ 倍数显示：×9 (炸弹×2)
✅ 得分正确：符合通用计分公式
✅ 控制台显示：bombCount: 2
```

---

### 场景4：王炸

**条件**：
- 游戏中出现1个王炸（大王+小王）
- 无其他倍数

**预期结果**：
- 基础分：5000（1 底分）
- 倍数：×8（1 个王炸，对应王炸倍数 8）
- 地主获胜：地主 +基础分×倍数×2，农民各 -基础分×倍数
- 农民获胜：地主 -基础分×倍数×2，农民各 +基础分×倍数

**测试步骤**：
1. 开始游戏
2. 出1次王炸
3. 某方出完所有牌
4. 查看结算界面

**验证**：
```
✅ 倍数显示：×8 (王炸×1)
✅ 得分正确：符合通用计分公式
✅ 控制台显示：rocketCount: 1
```

---

### 场景5：炸弹+王炸

**条件**：
- 游戏中出现1个炸弹和1个王炸
- 无其他倍数

**预期结果**：
- 基础分：5000（1 底分）
- 倍数：×24（1 个炸弹 + 1 个王炸：3 × 8 = 24）
- 地主获胜：地主 +基础分×倍数×2，农民各 -基础分×倍数
- 农民获胜：地主 -基础分×倍数×2，农民各 +基础分×倍数

**测试步骤**：
1. 开始游戏
2. 出1次炸弹和1次王炸
3. 某方出完所有牌
4. 查看结算界面

**验证**：
```
✅ 倍数显示：×24 (炸弹×1, 王炸×1)
✅ 得分正确：符合通用计分公式
✅ 控制台显示：bombCount: 1, rocketCount: 1
```

---

### 场景6：春天

**条件**：
- 地主获胜
- 农民一张牌都没出过（手牌数=17）

**预期结果**：
- 基础分：5000（1 底分）
- 倍数：×16（春天倍数）
- 地主 +基础分×倍数×2，农民各 -基础分×倍数

**测试步骤**：
1. 开始游戏，地主拿到好牌
2. 地主连续出牌，农民一直不出
3. 地主出完所有牌
4. 查看结算界面

**验证**：
```
✅ 倍数显示：×16 (春天)
✅ 得分正确：符合通用计分公式
✅ 控制台显示：isSpring: true
```

---

### 场景7：反春

**条件**：
- 农民获胜
- 地主一张牌都没出过（手牌数=20）

**预期结果**：
- 基础分：5000（1 底分）
- 倍数：×16（反春倍数）
- 地主 -基础分×倍数×2，农民各 +基础分×倍数

**测试步骤**：
1. 开始游戏，农民拿到好牌
2. 农民连续出牌，地主一直不出
3. 农民出完所有牌
4. 查看结算界面

**验证**：
```
✅ 倍数显示：×16 (反春)
✅ 得分正确：符合通用计分公式
✅ 控制台显示：isAntiSpring: true
```

---

### 场景8：极限倍数

**条件**：
- 2个炸弹 + 1个王炸 + 春天
- 地主获胜

**预期结果**：
- 基础分：5000（1 底分）
- 倍数：×1152（2 炸弹 + 1 王炸 + 春天：3^2 × 8 × 16 = 1152）
- 地主 +基础分×倍数×2，农民各 -基础分×倍数

**测试步骤**：
1. 开始游戏
2. 出2次炸弹和1次王炸
3. 地主出完所有牌，农民未出牌
4. 查看结算界面

**验证**：
```
✅ 倍数显示：×1152 (炸弹×2, 王炸×1, 春天)
✅ 得分正确：符合通用计分公式
✅ 控制台显示完整得分信息
```

---

## 🔍 调试方法

### 查看详细得分

打开浏览器控制台（F12），查看日志：

```javascript
// 游戏结束时会输出（示例：基础局，无炸弹/王炸）
💰 [结算] 详细得分: {
  baseScore: 5000,
  bombCount: 0,
  rocketCount: 0,
  isSpring: false,
  isAntiSpring: false,
  landlordWin: true,
  playerScores: [...]
}

// 每个玩家的得分
   玩家A (landlord): +10000
   玩家B (farmer): -5000
   玩家C (farmer): -5000
```

### 手动测试计分

在控制台运行：

```javascript
// 查看游戏历史
console.log('出牌历史:', room.gameState.playHistory);

// 查看玩家手牌数
room.players.forEach(p => {
  console.log(`${p.name}: ${p.cardCount}张牌`);
});
```

---

## 📊 结算界面说明

### 显示内容

```
🎊 地主获胜！ / 农民获胜！

👑 获胜者
玩家名字
角色（地主/农民）

💰 得分详情
基础分：5000
倍数：×24 (炸弹×1, 王炸×1)
总得分：+基础分×倍数×2 / -基础分×倍数
```

### 颜色编码

- **绿色** (+分数): 获胜方得分
- **红色** (-分数): 失败方失分

---

## 🐛 常见问题

### Q1: 倍数计算不正确？

**检查**：
1. 查看控制台的 `bombCount` 和 `rocketCount`
2. 确认出牌历史是否正确记录
3. 检查牌型识别是否正确

**解决**：
```javascript
// 查看出牌历史
console.log(room.gameState.playHistory);

// 查看每次出牌的牌型
playHistory.forEach(play => {
  console.log(play.cardType.type);
});
```

---

### Q2: 春天/反春判断错误？

**检查**：
1. 查看玩家手牌数
2. 农民初始17张，地主初始20张
3. 确认是否真的一张牌都没出

**解决**：
```javascript
// 查看玩家手牌数
room.players.forEach(p => {
  console.log(`${p.name} (${p.role}): ${p.cardCount}张`);
});
```

---

### Q3: 得分显示为NaN？

**检查**：
1. 后端是否正确返回 `score` 对象
2. 前端是否正确解析 `score` 数据

**解决**：
```javascript
// 查看完整的game_over数据
socket.on('game_over', (data) => {
  console.log('完整数据:', data);
  console.log('得分对象:', data.score);
});
```

---

## ✅ 验收标准

### 功能完整性
- [x] 基础得分计算（基础分 5000）
- [x] 炸弹倍数（×3^n）
- [x] 王炸倍数（×8^n）
- [x] 春天倍数（×16）
- [x] 反春倍数（×16）
- [x] 倍数叠加计算
- [x] 个人得分计算

### 界面显示
- [x] 基础分显示
- [x] 倍数显示
- [x] 倍数说明（炸弹、王炸等）
- [x] 总得分显示
- [x] 得分颜色编码
- [x] 控制台详细日志

### 准确性
- [x] 地主获胜得分正确
- [x] 农民获胜得分正确
- [x] 炸弹倍数正确
- [x] 王炸倍数正确
- [x] 春天判断正确
- [x] 反春判断正确

---

## 📝 测试记录模板

```markdown
### 测试日期：2025-10-29
### 测试人员：[你的名字]

#### 测试结果

| 场景 | 预期倍数 | 实际倍数 | 预期得分 | 实际得分 | 状态 |
|------|---------|---------|---------|---------|------|
| 基础得分 | ×1 | ×1 | 符合计分公式 | 符合计分公式 | ✅ |
| 单个炸弹 | ×3 | ×3 | 符合计分公式 | 符合计分公式 | ✅ |
| 王炸 | ×8 | ×8 | 符合计分公式 | 符合计分公式 | ✅ |
| 春天 | ×16 | ×16 | 符合计分公式 | 符合计分公式 | ✅ |

#### 问题记录
1. [描述问题]
2. [描述问题]

#### 建议
1. [改进建议]
2. [改进建议]
```

---

**创建时间**: 2025-10-29  
**最后更新**: 2025-10-29  
**版本**: v1.1.0
