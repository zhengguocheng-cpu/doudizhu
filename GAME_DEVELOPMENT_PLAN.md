# 斗地主游戏 - 开发计划

## 📅 开发时间：2025年10月27日起

## 🎯 总体目标

在现有基础上，完成斗地主游戏的核心玩法功能，确保不破坏已测试通过的功能。

---

## ✅ 已完成功能（不可修改）

### 第一阶段：基础通信 ✅
- Socket.IO连接和重连
- 房间管理和玩家加入
- 准备状态同步

### 第二阶段：发牌和抢地主 ✅
- 发牌动画显示
- 抢地主界面和倒计时
- 手牌显示优化

---

## 🚀 待开发功能

### 第三阶段：地主确定和底牌 ⏳

#### 功能1：地主确定逻辑
**后端实现**：
- 文件：`backend/src/services/socket/GameFlowHandler.ts`
- 方法：`determineLandlord()`
- 逻辑：
  1. 收集所有玩家的抢地主选择
  2. 确定地主（随机或按规则）
  3. 广播地主确定事件

**前端实现**：
- 文件：`frontend/public/room/js/room-simple.js`
- 事件：`landlord_determined`
- 显示：
  1. 在聊天框显示"XXX成为地主"
  2. 给地主玩家添加👑标记
  3. 显示底牌

**测试步骤**：
1. 3个玩家都选择"抢地主"
2. 验证地主确定逻辑
3. 验证地主标记显示
4. 验证底牌显示

**不修改**：
- 发牌动画
- 抢地主界面
- 手牌显示

---

#### 功能2：底牌显示
**后端实现**：
- 文件：`backend/src/services/socket/GameFlowHandler.ts`
- 事件：`landlord_cards_update`（已存在，使用广播）
- 数据：
```typescript
{
    landlordId: string,
    cards: string[],
    bottomCards: string[]
}
```

**前端实现**：
- 文件：`frontend/public/room/js/room-simple.js`
- HTML：添加底牌显示区域
- CSS：底牌样式
- 功能：
  1. 桌面中央显示3张底牌
  2. 底牌飞向地主
  3. 地主手牌更新

**测试步骤**：
1. 确定地主后显示底牌
2. 验证底牌动画
3. 验证地主手牌更新为20张

**不修改**：
- 发牌动画
- 抢地主界面

---

### 第四阶段：出牌功能 ⏳

#### 功能3：选牌功能
**前端实现**：
- 文件：`frontend/public/room/js/room-simple.js`
- 功能：
  1. 点击牌选中/取消选中
  2. 选中的牌向上移动
  3. 记录选中的牌

**CSS样式**：
```css
.card.selected {
    transform: translateY(-20px);
    border-color: #e74c3c;
}
```

**测试步骤**：
1. 点击牌，验证选中效果
2. 再次点击，验证取消选中
3. 选中多张牌，验证状态

**不修改**：
- 手牌显示布局
- 发牌动画

---

#### 功能4：牌型判断
**后端实现**：
- 文件：`backend/src/services/game/CardValidator.ts`（新建）
- 功能：
  1. 单牌、对子、三张
  2. 顺子、连对、飞机
  3. 炸弹、王炸
  4. 带牌组合

**方法**：
```typescript
class CardValidator {
    static validateCardType(cards: string[]): CardType
    static canBeat(cards: string[], lastCards: string[]): boolean
}
```

**测试步骤**：
1. 单元测试各种牌型
2. 测试牌型比较逻辑
3. 测试边界情况

**不修改**：
- 任何前端代码

---

#### 功能5：出牌操作
**后端实现**：
- 文件：`backend/src/services/socket/GameFlowHandler.ts`
- 事件：`play_cards`
- 逻辑：
  1. 验证是否轮到该玩家
  2. 验证牌型是否合法
  3. 验证是否能压过上家
  4. 更新游戏状态
  5. 广播出牌事件

**前端实现**：
- 文件：`frontend/public/room/js/room-simple.js`
- 按钮：
  1. "出牌"按钮 - 发送选中的牌
  2. "不出"按钮 - 跳过本轮
  3. "提示"按钮 - 智能提示

**测试步骤**：
1. 轮到玩家时显示按钮
2. 点击"出牌"，验证牌型判断
3. 点击"不出"，验证轮次切换
4. 验证非法出牌提示

**不修改**：
- 抢地主界面
- 发牌动画

---

### 第五阶段：游戏结算 ⏳

#### 功能6：胜负判断
**后端实现**：
- 文件：`backend/src/services/socket/GameFlowHandler.ts`
- 逻辑：
  1. 检测玩家手牌是否为空
  2. 计算得分（倍数）
  3. 广播游戏结束事件

**前端实现**：
- 文件：`frontend/public/room/js/room-simple.js`
- 显示：
  1. 胜利/失败动画
  2. 得分显示
  3. "再来一局"按钮

**测试步骤**：
1. 地主赢，验证结算
2. 农民赢，验证结算
3. 验证得分计算
4. 验证"再来一局"

**不修改**：
- 所有已有功能

---

## 📋 开发顺序

### 第1步：地主确定（1-2小时）
- [ ] 后端：实现地主确定逻辑
- [ ] 前端：显示地主标记
- [ ] 测试：验证地主确定

### 第2步：底牌显示（1-2小时）
- [ ] 后端：广播底牌事件
- [ ] 前端：底牌动画
- [ ] 测试：验证底牌飞向地主

### 第3步：选牌功能（1小时）
- [ ] 前端：选牌交互
- [ ] CSS：选中样式
- [ ] 测试：验证选牌状态

### 第4步：牌型判断（2-3小时）
- [ ] 后端：CardValidator类
- [ ] 单元测试：各种牌型
- [ ] 测试：边界情况

### 第5步：出牌操作（2-3小时）
- [ ] 后端：出牌逻辑
- [ ] 前端：出牌按钮
- [ ] 测试：完整出牌流程

### 第6步：游戏结算（1-2小时）
- [ ] 后端：胜负判断
- [ ] 前端：结算界面
- [ ] 测试：各种结算场景

---

## 🧪 测试策略

### 单元测试
- CardValidator 牌型判断
- 得分计算逻辑

### 集成测试
- 完整游戏流程
- 多人同时出牌
- 网络断线重连

### 回归测试
每个功能完成后，必须测试：
- ✅ Socket重连
- ✅ 发牌动画
- ✅ 抢地主
- ✅ 手牌显示

---

## 📦 代码组织原则

### 1. 模块化
- 每个功能独立文件
- 不修改已有功能代码

### 2. 事件驱动
- 使用Socket.IO事件通信
- 前后端解耦

### 3. 向后兼容
- 新增事件不影响旧事件
- 保留旧接口

### 4. 增量开发
- 每个功能独立测试
- 逐步集成

---

## 🎯 成功标准

### 功能完整性
- ✅ 完整游戏流程
- ✅ 所有牌型支持
- ✅ 正确的胜负判断

### 稳定性
- ✅ 无崩溃
- ✅ 无数据丢失
- ✅ 断线重连正常

### 用户体验
- ✅ 流畅的动画
- ✅ 清晰的提示
- ✅ 友好的界面

---

## 📝 开发日志

每完成一个功能，更新：
- `CHANGELOG_2025_10_27.md`
- Git提交记录
- 测试报告

---

**开始时间**：2025年10月27日 07:10
**预计完成**：2025年10月27日 20:00
**当前阶段**：准备开始第三阶段
