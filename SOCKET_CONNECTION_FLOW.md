# Socketè¿æ¥å®Œæ•´è°ƒç”¨æµç¨‹åˆ†æ

## ğŸ“Š è°ƒç”¨æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ï¼‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ 1. å»ºç«‹Socketè¿æ¥
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Socket.IO Server                              â”‚
â”‚                  (backend/src/app.ts)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ 2. è§¦å‘ 'connection' äº‹ä»¶
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Application.setupSocketIO() - Line 142                          â”‚
â”‚  â”œâ”€ console.log(`ç”¨æˆ·è¿æ¥: ${socket.id}`)                        â”‚
â”‚  â””â”€ è°ƒç”¨è®¤è¯ä¸­é—´ä»¶                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ 3. è®¤è¯æµç¨‹å¼€å§‹
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AuthMiddleware.authenticateSocket()                             â”‚
â”‚  (backend/src/middleware/AuthMiddleware.ts - Line 47)            â”‚
â”‚  â””â”€ æ£€æŸ¥ socket.handshake.auth å‚æ•°                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ 4. å¤„ç†è®¤è¯æ•°æ®
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AuthMiddleware.handleAuthFromConnection() - Line 79             â”‚
â”‚  â”œâ”€ log: "Processing auth from connection"                       â”‚
â”‚  â”œâ”€ æå– auth.userId, auth.pageNavigationToken                   â”‚
â”‚  â””â”€ è°ƒç”¨è®¤è¯æ–¹æ³•                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ 5. ç”¨æˆ·IDè®¤è¯
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AuthMiddleware.authenticateByUserId() - Line 189                â”‚
â”‚  â”œâ”€ æ¥æ”¶å‚æ•°: userId, socketId, pageNavigationToken             â”‚
â”‚  â””â”€ è°ƒç”¨ç”¨æˆ·ç®¡ç†å™¨                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ 6. ç”¨æˆ·è®¤è¯é€»è¾‘
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UserManager.authenticateUser() - Line 21                        â”‚
â”‚  (backend/src/services/user/userManager.ts)                      â”‚
â”‚  â”œâ”€ æŸ¥æ‰¾ç”¨æˆ·: findUserByName()                                   â”‚
â”‚  â”œâ”€ å¦‚æœä¸å­˜åœ¨: createUser()                                     â”‚
â”‚  â”‚   â””â”€ console.log("âœ… [MPA] æ–°ç”¨æˆ·æ³¨å†Œ")                       â”‚
â”‚  â”œâ”€ å¦‚æœå­˜åœ¨ä¸”åœ¨çº¿:                                              â”‚
â”‚  â”‚   â”œâ”€ æ£€æŸ¥ pageNavigationToken                                â”‚
â”‚  â”‚   â”œâ”€ æœ‰ä»¤ç‰Œ: å¼ºåˆ¶æ–­å¼€æ—§ä¼šè¯ï¼Œå…è®¸æ–°è¿æ¥                       â”‚
â”‚  â”‚   â”‚   â””â”€ console.log("âœ… [MPA] æ£€æµ‹åˆ°é¡µé¢è·³è½¬ä»¤ç‰Œ")           â”‚
â”‚  â”‚   â””â”€ æ— ä»¤ç‰Œ: æ£€æŸ¥æ´»è·ƒä¼šè¯                                     â”‚
â”‚  â”‚       â”œâ”€ æœ‰ä¼šè¯: æ‹’ç»ï¼ˆé‡å¤ç™»å½•ï¼‰                             â”‚
â”‚  â”‚       â””â”€ æ— ä¼šè¯: å…è®¸                                         â”‚
â”‚  â””â”€ è¿”å› Player å¯¹è±¡                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ 7. åˆ›å»ºä¼šè¯
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PlayerSession.createUserSession() - Line 102                    â”‚
â”‚  (backend/src/services/player/playerSession.ts)                  â”‚
â”‚  â”œâ”€ æŸ¥æ‰¾æ—§ä¼šè¯: findSessionByUserId()                           â”‚
â”‚  â”œâ”€ å¦‚æœæœ‰æ—§ä¼šè¯: setOnlineStatus(false)                        â”‚
â”‚  â”‚   â””â”€ console.log("æ–­å¼€ç”¨æˆ·çš„æ—§è¿æ¥")                          â”‚
â”‚  â”œâ”€ åˆ›å»ºæ–°ä¼šè¯: createSession()                                 â”‚
â”‚  â”œâ”€ è®¾ç½®åœ¨çº¿: setOnlineStatus(true)                             â”‚
â”‚  â””â”€ è¿”å› sessionId                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ 8. è®¤è¯æˆåŠŸå¤„ç†
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AuthMiddleware.handleAuthFromConnection() - Line 96             â”‚
â”‚  â”œâ”€ ç»‘å®šç”¨æˆ·ä¿¡æ¯åˆ°Socket                                         â”‚
â”‚  â”‚   â”œâ”€ socket.userId = user.name                               â”‚
â”‚  â”‚   â”œâ”€ socket.userName = user.name                             â”‚
â”‚  â”‚   â”œâ”€ socket.sessionId = sessionId                            â”‚
â”‚  â”‚   â””â”€ socket.authenticated = true                             â”‚
â”‚  â”œâ”€ æ›´æ–°ç”¨æˆ·è¿æ¥: userManager.updateUserConnection()            â”‚
â”‚  â”œâ”€ log: "User authenticated from connection successfully"       â”‚
â”‚  â””â”€ å‘å¸ƒè®¤è¯æˆåŠŸäº‹ä»¶                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ 9. å‘å¸ƒäº‹ä»¶
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AuthMiddleware.emitUserAuthenticatedEvent() - Line 209          â”‚
â”‚  â””â”€ log: "User authenticated event emitted"                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ 10. å®Œæˆè®¤è¯ä¸­é—´ä»¶
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AuthMiddleware.authenticateSocket() - Line 64                   â”‚
â”‚  â”œâ”€ log: "Socket authentication middleware setup"                â”‚
â”‚  â””â”€ next() - ç»§ç»­ä¸‹ä¸€ä¸ªä¸­é—´ä»¶                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ 11. è®¾ç½®Socketäº‹ä»¶å¤„ç†å™¨
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Application.setupSocketEventHandlers() - Line 164               â”‚
â”‚  (backend/src/app.ts)                                            â”‚
â”‚  â””â”€ æ³¨å†Œå„ç§äº‹ä»¶ç›‘å¬å™¨                                           â”‚
â”‚      â”œâ”€ socket.on('join_game', ...)                             â”‚
â”‚      â”œâ”€ socket.on('get_rooms', ...)                             â”‚
â”‚      â”œâ”€ socket.on('ready', ...)                                 â”‚
â”‚      â””â”€ ... å…¶ä»–äº‹ä»¶                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ 12. å®¢æˆ·ç«¯è¯·æ±‚æˆ¿é—´åˆ—è¡¨
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SocketEventHandler.handleGetRooms() - Line 46                   â”‚
â”‚  (backend/src/services/socket/SocketEventHandler.ts)             â”‚
â”‚  â”œâ”€ è·å–æˆ¿é—´åˆ—è¡¨: roomService.getAllRooms()                     â”‚
â”‚  â”œâ”€ å‘é€ç»™å®¢æˆ·ç«¯: socket.emit('rooms_list', ...)                â”‚
â”‚  â””â”€ console.log("å‘é€æˆ¿é—´åˆ—è¡¨ç»™å®¢æˆ·ç«¯")                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” è¯¦ç»†åˆ†æ

### **é˜¶æ®µ1: è¿æ¥å»ºç«‹ (Lines 1-3)**
```typescript
// æ–‡ä»¶: backend/src/app.ts (Line 142-143)
this.io.on('connection', (socket) => {
  console.log(`ç”¨æˆ·è¿æ¥: ${socket.id}`);  // è¾“å‡º: "ç”¨æˆ·è¿æ¥: KiUtLcGrRcklx19fAAAB"
```

**è§¦å‘æ¡ä»¶**: å®¢æˆ·ç«¯è°ƒç”¨ `io('http://localhost:3000')`

---

### **é˜¶æ®µ2: è®¤è¯ä¸­é—´ä»¶ (Lines 4-10)**

#### **2.1 è®¤è¯å¼€å§‹**
```typescript
// æ–‡ä»¶: backend/src/middleware/AuthMiddleware.ts (Line 81)
this.log(LogLevel.INFO, 'Processing auth from connection', {
  socketId: socket.id,
  authData: auth
});
```
**è¾“å‡º**: 
```json
{"timestamp":"...","level":"INFO","message":"Processing auth from connection",
 "metadata":{"socketId":"KiUtLcGrRcklx19fAAAB",
             "authData":{"userId":"ç©å®¶A","userName":"ç©å®¶A","pageNavigationToken":null}}}
```

#### **2.2 ç”¨æˆ·è®¤è¯**
```typescript
// æ–‡ä»¶: backend/src/services/user/userManager.ts (Line 30 æˆ– 70)
console.log(`âœ… [MPA] æ–°ç”¨æˆ·æ³¨å†Œ: ${trimmedUserName}`);
// æˆ–
console.log(`âœ… [MPA] ç”¨æˆ·ç™»å½•: ${trimmedUserName}`);
```
**è¾“å‡º**: `âœ… [MPA] æ–°ç”¨æˆ·æ³¨å†Œ: ç©å®¶A`

#### **2.3 è®¤è¯æˆåŠŸ**
```typescript
// æ–‡ä»¶: backend/src/middleware/AuthMiddleware.ts (Line 107)
this.log(LogLevel.INFO, 'User authenticated from connection successfully', {
  userId: result.user.name,
  socketId: socket.id
});
```
**è¾“å‡º**:
```json
{"timestamp":"...","level":"INFO","message":"User authenticated from connection successfully",
 "metadata":{"userId":"ç©å®¶A","socketId":"KiUtLcGrRcklx19fAAAB"}}
```

#### **2.4 å‘å¸ƒäº‹ä»¶**
```typescript
// æ–‡ä»¶: backend/src/middleware/AuthMiddleware.ts (Line 211)
this.log(LogLevel.INFO, 'User authenticated event emitted', { userId: user.name });
```
**è¾“å‡º**:
```json
{"timestamp":"...","level":"INFO","message":"User authenticated event emitted",
 "metadata":{"userId":"ç©å®¶A"}}
```

#### **2.5 ä¸­é—´ä»¶å®Œæˆ**
```typescript
// æ–‡ä»¶: backend/src/middleware/AuthMiddleware.ts (Line 64)
this.log(LogLevel.INFO, 'Socket authentication middleware setup', {
  socketId: socket.id,
  authData: socket.handshake.auth
});
```
**è¾“å‡º**:
```json
{"timestamp":"...","level":"INFO","message":"Socket authentication middleware setup",
 "metadata":{"socketId":"KiUtLcGrRcklx19fAAAB",...}}
```

---

### **é˜¶æ®µ3: é¡µé¢è·³è½¬é‡è¿ (Lines 11-12)**

å½“ç”¨æˆ·ä»ç™»å½•é¡µè·³è½¬åˆ°å¤§å…é¡µæ—¶ï¼š

#### **3.1 æ—§è¿æ¥æ–­å¼€**
```typescript
// æ–‡ä»¶: backend/src/middleware/AuthMiddleware.ts (Line 146)
this.log(LogLevel.INFO, 'Socket disconnected', {
  socketId: socket.id,
  userId: socket.userId
});
```
**è¾“å‡º**:
```json
{"timestamp":"...","level":"INFO","message":"Socket disconnected",
 "metadata":{"socketId":"KiUtLcGrRcklx19fAAAB","userId":"ç©å®¶A"}}
```

#### **3.2 è®¾ç½®ç”¨æˆ·ç¦»çº¿**
```typescript
// æ–‡ä»¶: backend/src/middleware/AuthMiddleware.ts (Line 153)
this.log(LogLevel.INFO, 'User set offline', {
  userId: socket.userId
});
```

#### **3.3 è®¾ç½®ä¼šè¯ç¦»çº¿**
```typescript
// æ–‡ä»¶: backend/src/middleware/AuthMiddleware.ts (Line 161)
this.log(LogLevel.INFO, 'Session set offline', {
  sessionId: socket.sessionId
});
```

#### **3.4 æ–°è¿æ¥å»ºç«‹ï¼ˆå¸¦ä»¤ç‰Œï¼‰**
```typescript
// å‰ç«¯ç”Ÿæˆä»¤ç‰Œ
pageNavigationToken = "1761831760271_4hafmok9o"

// åç«¯æ£€æµ‹åˆ°ä»¤ç‰Œ
console.log(`âœ… [MPA] æ£€æµ‹åˆ°é¡µé¢è·³è½¬ä»¤ç‰Œï¼Œå…è®¸æ–°è¿æ¥`);
```

---

### **é˜¶æ®µ4: è·å–æˆ¿é—´åˆ—è¡¨ (Line 13)**

```typescript
// æ–‡ä»¶: backend/src/services/socket/SocketEventHandler.ts (Line 63)
console.log(`å‘é€æˆ¿é—´åˆ—è¡¨ç»™å®¢æˆ·ç«¯ ${socket.id}ï¼Œæˆ¿é—´æ•°é‡: ${rooms.length}`);
```
**è¾“å‡º**: `å‘é€æˆ¿é—´åˆ—è¡¨ç»™å®¢æˆ·ç«¯ gZ02p1PAMV-yFlphAAAFï¼Œæˆ¿é—´æ•°é‡: 6`

---

## ğŸ“‹ å…³é”®å‡½æ•°è°ƒç”¨é“¾

### **é¦–æ¬¡è¿æ¥**
```
io.on('connection')
  â””â”€> Application.setupSocketIO()
      â””â”€> AuthMiddleware.authenticateSocket()
          â””â”€> AuthMiddleware.handleAuthFromConnection()
              â””â”€> AuthMiddleware.authenticateByUserId()
                  â””â”€> UserManager.authenticateUser()
                      â”œâ”€> UserManager.createUser() [æ–°ç”¨æˆ·]
                      â””â”€> PlayerSession.createUserSession()
                          â””â”€> è¿”å› sessionId
```

### **é¡µé¢è·³è½¬é‡è¿**
```
æ—§è¿æ¥æ–­å¼€:
  socket.disconnect()
    â””â”€> AuthMiddleware.handleDisconnection()
        â”œâ”€> UserManager.setUserOffline()
        â””â”€> PlayerSession.setOnlineStatus(sessionId, false)

æ–°è¿æ¥å»ºç«‹:
  io.on('connection')
    â””â”€> ... (åŒé¦–æ¬¡è¿æ¥)
        â””â”€> UserManager.authenticateUser(userId, socketId, pageNavigationToken)
            â””â”€> æ£€æµ‹åˆ°ä»¤ç‰Œ â†’ å¼ºåˆ¶æ–­å¼€æ—§ä¼šè¯ â†’ å…è®¸æ–°è¿æ¥
```

---

## ğŸ¯ æ—¥å¿—è¾“å‡ºä½ç½®æ€»ç»“

| æ—¥å¿—å†…å®¹ | æ–‡ä»¶ä½ç½® | è¡Œå· |
|---------|---------|------|
| `ç”¨æˆ·è¿æ¥: xxx` | `app.ts` | 143 |
| `Processing auth from connection` | `AuthMiddleware.ts` | 81 |
| `âœ… [MPA] æ–°ç”¨æˆ·æ³¨å†Œ` | `userManager.ts` | 30 |
| `âœ… [MPA] ç”¨æˆ·ç™»å½•` | `userManager.ts` | 70 |
| `æ–­å¼€ç”¨æˆ·çš„æ—§è¿æ¥` | `playerSession.ts` | 108 |
| `User authenticated from connection successfully` | `AuthMiddleware.ts` | 107 |
| `User authenticated event emitted` | `AuthMiddleware.ts` | 211 |
| `Socket authentication middleware setup` | `AuthMiddleware.ts` | 64 |
| `Socket disconnected` | `AuthMiddleware.ts` | 146 |
| `User set offline` | `AuthMiddleware.ts` | 153 |
| `Session set offline` | `AuthMiddleware.ts` | 161 |
| `å‘é€æˆ¿é—´åˆ—è¡¨ç»™å®¢æˆ·ç«¯` | `SocketEventHandler.ts` | 63 |

---

## ğŸ”§ å¦‚ä½•å…³é—­è¿™äº›æ—¥å¿—

### **1. å…³é—­ console.log æ—¥å¿—**
```typescript
// backend/src/app.ts (Line 143)
// console.log(`ç”¨æˆ·è¿æ¥: ${socket.id}`);

// backend/src/services/user/userManager.ts (Line 30, 70, etc.)
// console.log(`âœ… [MPA] æ–°ç”¨æˆ·æ³¨å†Œ: ${trimmedUserName}`);

// backend/src/services/socket/SocketEventHandler.ts (Line 63)
// console.log(`å‘é€æˆ¿é—´åˆ—è¡¨ç»™å®¢æˆ·ç«¯ ${socket.id}ï¼Œæˆ¿é—´æ•°é‡: ${rooms.length}`);
```

### **2. å…³é—­ç»“æ„åŒ–æ—¥å¿—ï¼ˆJSONæ ¼å¼ï¼‰**
```typescript
// backend/src/core/BaseService.ts (Line 79)
// this.logger.log(`[${timestamp}] ${levelName} [${serviceName}] ${message}`, metadata || '');
```

æˆ–è€…åœ¨ `AuthMiddleware.ts` ä¸­æ³¨é‡Šæ‰æ‰€æœ‰ `this.log()` è°ƒç”¨ã€‚

---

## ğŸ’¡ å»ºè®®

1. **ä¿ç•™å…³é”®æ—¥å¿—**: 
   - ç”¨æˆ·æ³¨å†Œ/ç™»å½•
   - è®¤è¯å¤±è´¥
   - é‡å¤ç™»å½•æ‹’ç»

2. **å…³é—­å†—ä½™æ—¥å¿—**:
   - æ¯æ¬¡è¿æ¥çš„è¯¦ç»†ä¿¡æ¯
   - ä¸­é—´ä»¶è®¾ç½®å®Œæˆ
   - æˆ¿é—´åˆ—è¡¨å‘é€

3. **ä½¿ç”¨æ—¥å¿—çº§åˆ«**:
   - ERROR: é”™è¯¯
   - WARN: è­¦å‘Šï¼ˆå¦‚é‡å¤ç™»å½•å°è¯•ï¼‰
   - INFO: é‡è¦ä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ·æ³¨å†Œï¼‰
   - DEBUG: è°ƒè¯•ä¿¡æ¯ï¼ˆå¦‚è¿æ¥è¯¦æƒ…ï¼‰

4. **ç¯å¢ƒå˜é‡æ§åˆ¶**:
   ```typescript
   if (process.env.NODE_ENV === 'development') {
     console.log('è¯¦ç»†æ—¥å¿—');
   }
   ```
