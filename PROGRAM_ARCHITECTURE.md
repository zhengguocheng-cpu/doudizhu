# æ–—åœ°ä¸»æ¸¸æˆ - ç¨‹åºæ¶æ„æ–‡æ¡£

## ğŸ“‹ ç›®å½•
1. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
2. [åç«¯æ¶æ„](#åç«¯æ¶æ„)
3. [å‰ç«¯æ¶æ„](#å‰ç«¯æ¶æ„)
4. [å‰åç«¯äº¤äº’æµç¨‹](#å‰åç«¯äº¤äº’æµç¨‹)
5. [å®Œæ•´æ¸¸æˆæµç¨‹](#å®Œæ•´æ¸¸æˆæµç¨‹)

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

### æŠ€æœ¯æ ˆ
```
å‰ç«¯ï¼šHTML5 + CSS3 + Vanilla JavaScript
åç«¯ï¼šNode.js + Express + TypeScript
å®æ—¶é€šä¿¡ï¼šSocket.IO
```

### æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æµè§ˆå™¨å®¢æˆ·ç«¯                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ ç™»å½•é¡µé¢ â”‚â†’ â”‚ å¤§å…é¡µé¢ â”‚â†’ â”‚ æˆ¿é—´é¡µé¢ â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â†“            â†“            â†“              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚    â”‚   Socket.IO Client (å…¨å±€)      â”‚           â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â†• WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Node.js åç«¯æœåŠ¡å™¨                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         Socket.IO Server                  â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚  â”‚ EventHandler â”‚  â”‚ GameFlowHandlerâ”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         Express HTTP Server               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚            æœåŠ¡å±‚ (Services)              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚ Room   â”‚ â”‚ Card   â”‚ â”‚ Game   â”‚       â”‚   â”‚
â”‚  â”‚  â”‚Service â”‚ â”‚Service â”‚ â”‚Service â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ åç«¯æ¶æ„

### ç›®å½•ç»“æ„
```
backend/src/
â”œâ”€â”€ app.ts                      # åº”ç”¨å…¥å£
â”œâ”€â”€ server.ts                   # æœåŠ¡å™¨å¯åŠ¨
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ socket/
â”‚   â”‚   â”œâ”€â”€ SocketEventHandler.ts   # Socketäº‹ä»¶å¤„ç†
â”‚   â”‚   â””â”€â”€ GameFlowHandler.ts      # æ¸¸æˆæµç¨‹å¤„ç†
â”‚   â”œâ”€â”€ room/
â”‚   â”‚   â”œâ”€â”€ roomService.ts          # æˆ¿é—´æ•°æ®ç®¡ç†
â”‚   â”‚   â””â”€â”€ roomManager.ts          # æˆ¿é—´ç®¡ç†å™¨
â”‚   â”œâ”€â”€ card/
â”‚   â”‚   â”œâ”€â”€ cardGenerator.ts        # ç”Ÿæˆç‰Œ
â”‚   â”‚   â””â”€â”€ cardShuffler.ts         # æ´—ç‰Œ
â”‚   â””â”€â”€ game/
â”‚       â”œâ”€â”€ CardTypeDetector.ts     # ç‰Œå‹æ£€æµ‹
â”‚       â””â”€â”€ CardPlayValidator.ts    # å‡ºç‰ŒéªŒè¯
â””â”€â”€ types/                      # ç±»å‹å®šä¹‰
```

### æ ¸å¿ƒç±»

#### SocketEventHandler
**èŒè´£**ï¼šå¤„ç†Socket.IOäº‹ä»¶
```typescript
å¤„ç†çš„äº‹ä»¶ï¼š
- join_game: åŠ å…¥æ¸¸æˆ
- player_ready: ç©å®¶å‡†å¤‡
- send_message: å‘é€æ¶ˆæ¯
- bid: æŠ¢åœ°ä¸»
- play_cards: å‡ºç‰Œ
```

#### GameFlowHandler
**èŒè´£**ï¼šæ¸¸æˆæµç¨‹æ§åˆ¶
```typescript
ä¸»è¦æ–¹æ³•ï¼š
- startGame(): å¼€å§‹æ¸¸æˆ
- dealCards(): å‘ç‰Œ
- startBidding(): å¼€å§‹æŠ¢åœ°ä¸»
- determineLandlord(): ç¡®å®šåœ°ä¸»
- handlePlayCards(): å¤„ç†å‡ºç‰Œ
```

#### RoomService
**èŒè´£**ï¼šæˆ¿é—´æ•°æ®ç®¡ç†ï¼ˆå•ä¾‹ï¼‰
```typescript
æ•°æ®ç»“æ„ï¼š
- rooms: Map<roomId, GameRoom>

ä¸»è¦æ–¹æ³•ï¼š
- getAllRooms(): è·å–æ‰€æœ‰æˆ¿é—´
- addPlayer(): æ·»åŠ ç©å®¶
- updatePlayerReady(): æ›´æ–°å‡†å¤‡çŠ¶æ€
```

---

## ğŸ¨ å‰ç«¯æ¶æ„

### é¡µé¢ç»“æ„
```
1. ç™»å½•é¡µé¢ (index.html)
   - è¾“å…¥ç”¨æˆ·å
   - é€‰æ‹©å¤´åƒ

2. å¤§å…é¡µé¢ (lobby.html)
   - æ˜¾ç¤ºæˆ¿é—´åˆ—è¡¨
   - é€‰æ‹©æˆ¿é—´åŠ å…¥

3. æˆ¿é—´é¡µé¢ (room.html)
   - æ¸¸æˆæ¡Œé¢
   - ç©å®¶æ‰‹ç‰Œ
   - èŠå¤©åŒºåŸŸ
```

### æ ¸å¿ƒç±»

#### GlobalSocketManager
**èŒè´£**ï¼šå…¨å±€Socketç®¡ç†ï¼ˆå•ä¾‹ï¼‰
```javascript
ç‰¹ç‚¹ï¼š
- å…¨å±€å”¯ä¸€å®ä¾‹
- é¡µé¢è·³è½¬ä¿æŒè¿æ¥
- è‡ªåŠ¨é‡è¿
```

#### DoudizhuRoomClient
**èŒè´£**ï¼šæˆ¿é—´é¡µé¢ä¸»é€»è¾‘
```javascript
ä¸»è¦æ–¹æ³•ï¼š
- joinRoom(): åŠ å…¥æˆ¿é—´
- handleBid(): æŠ¢åœ°ä¸»
- playCards(): å‡ºç‰Œ
- renderPlayerHand(): æ¸²æŸ“æ‰‹ç‰Œ
- dealCardsWithAnimation(): å‘ç‰ŒåŠ¨ç”»
- showBottomCardsAnimation(): åº•ç‰ŒåŠ¨ç”»
```

---

## ğŸ”„ å‰åç«¯äº¤äº’æµç¨‹

### 1. åŠ å…¥æˆ¿é—´
```
å‰ç«¯: emit('join_game', {roomId, userId})
  â†“
åç«¯: SocketEventHandler.handleJoinGame()
  â†“
åç«¯: socket.join(`room_${roomId}`)
  â†“
åç«¯: roomService.addPlayer()
  â†“
åç«¯: io.to(room).emit('player_joined')
  â†“
å‰ç«¯: æ›´æ–°ç©å®¶åˆ—è¡¨
```

### 2. æ¸¸æˆå¼€å§‹
```
å‰ç«¯: emit('player_ready')
  â†“
åç«¯: æ£€æŸ¥æ‰€æœ‰äººå‡†å¤‡
  â†“
åç«¯: GameFlowHandler.startGame()
  â†“
åç«¯: å‘ç‰Œï¼ˆ17+17+17+3ï¼‰
  â†“
åç«¯: io.to(room).emit('deal_cards_all')
  â†“
å‰ç«¯: å‘ç‰ŒåŠ¨ç”» + æ˜¾ç¤ºæ‰‹ç‰Œ
  â†“
åç«¯: io.to(room).emit('bidding_start')
  â†“
å‰ç«¯: æ˜¾ç¤ºæŠ¢åœ°ä¸»æŒ‰é’®
```

### 3. æŠ¢åœ°ä¸»
```
å‰ç«¯: emit('bid', {bid: true/false})
  â†“
åç«¯: è®°å½•é€‰æ‹©
  â†“
åç«¯: io.to(room).emit('bid_result')
  â†“
å‰ç«¯: æ˜¾ç¤ºé€‰æ‹©ç»“æœ
  â†“
åç«¯: 3äººéƒ½é€‰æ‹©å determineLandlord()
  â†“
åç«¯: åœ°ä¸»è·å¾—åº•ç‰Œï¼ˆ20å¼ ï¼‰
  â†“
åç«¯: io.to(room).emit('landlord_determined')
  â†“
å‰ç«¯: åº•ç‰ŒåŠ¨ç”» + åœ°ä¸»æ ‡è®°
```

---

## ğŸ® å®Œæ•´æ¸¸æˆæµç¨‹

```
1. ç™»å½•
   â†“
2. è¿›å…¥å¤§å…
   â†“
3. é€‰æ‹©æˆ¿é—´
   â†“
4. ç­‰å¾…3äºº
   â†“
5. æ‰€æœ‰äººå‡†å¤‡
   â†“
6. æ¸¸æˆå¼€å§‹
   â”œâ”€ å‘ç‰ŒåŠ¨ç”»
   â””â”€ æ¯äºº17å¼ ç‰Œ
   â†“
7. æŠ¢åœ°ä¸»
   â”œâ”€ ç¬¬ä¸€ä¸ªç©å®¶é€‰æ‹©
   â”œâ”€ ç¬¬äºŒä¸ªç©å®¶é€‰æ‹©
   â””â”€ ç¬¬ä¸‰ä¸ªç©å®¶é€‰æ‹©
   â†“
8. ç¡®å®šåœ°ä¸»
   â”œâ”€ æ˜¾ç¤ºåº•ç‰Œ
   â””â”€ åœ°ä¸»è·å¾—20å¼ ç‰Œ
   â†“
9. å‡ºç‰Œå¾ªç¯
   â”œâ”€ åœ°ä¸»å…ˆå‡º
   â”œâ”€ ä¸‹å®¶å‡ºç‰Œ/ä¸å‡º
   â””â”€ é‡å¤
   â†“
10. æ¸¸æˆç»“æŸ
    â””â”€ æ˜¾ç¤ºèƒœè´Ÿ
```

---

## ğŸ”” Socket.IOäº‹ä»¶è¡¨

### å®¢æˆ·ç«¯ â†’ æœåŠ¡å™¨
| äº‹ä»¶ | å‚æ•° | è¯´æ˜ |
|------|------|------|
| join_game | {roomId, userId} | åŠ å…¥æˆ¿é—´ |
| player_ready | {roomId, userId} | å‡†å¤‡æ¸¸æˆ |
| bid | {roomId, userId, bid} | æŠ¢åœ°ä¸» |
| play_cards | {roomId, userId, cards} | å‡ºç‰Œ |
| send_message | {roomId, message} | èŠå¤© |

### æœåŠ¡å™¨ â†’ å®¢æˆ·ç«¯
| äº‹ä»¶ | æ•°æ® | è¯´æ˜ |
|------|------|------|
| player_joined | {playerId, players} | ç©å®¶åŠ å…¥ |
| game_started | {roomId} | æ¸¸æˆå¼€å§‹ |
| deal_cards_all | {players, bottomCards} | å‘ç‰Œ |
| bidding_start | {firstBidderId} | æŠ¢åœ°ä¸»å¼€å§‹ |
| bid_result | {userId, bid} | æŠ¢åœ°ä¸»ç»“æœ |
| landlord_determined | {landlordId, landlordCards, bottomCards} | åœ°ä¸»ç¡®å®š |
| turn_to_play | {playerId} | è½®åˆ°å‡ºç‰Œ |
| cards_played | {playerId, cards} | å‡ºç‰Œ |
| game_over | {winner} | æ¸¸æˆç»“æŸ |

---

## ğŸ“Š å…³é”®æ•°æ®ç»“æ„

### GameRoom
```typescript
{
  id: string;
  name: string;
  players: Player[];
  maxPlayers: 3;
  status: 'waiting' | 'playing';
  gameState: {
    landlordId: string;
    currentPlayerId: string;
  };
  bottomCards: string[];
  biddingState: {
    bids: Array<{userId, bid}>;
    landlordId: string;
  };
}
```

### Player
```typescript
{
  id: string;
  name: string;
  avatar: string;
  ready: boolean;
  cards: string[];
  role: 'landlord' | 'farmer';
}
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æ›´æ–°æ—¶é—´**: 2025-10-27
