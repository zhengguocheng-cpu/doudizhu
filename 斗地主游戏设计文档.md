# æ–—åœ°ä¸»æ¸¸æˆè®¾è®¡æ–‡æ¡£

## æ¸¸æˆæ¦‚è¿°

æ–—åœ°ä¸»æ˜¯ä¸€æ¬¾ç»å…¸çš„å¤šäººçº¸ç‰Œæ¸¸æˆï¼Œé€šå¸¸ç”±3äººå‚ä¸ï¼Œä½¿ç”¨ä¸€å‰¯54å¼ æ‰‘å…‹ç‰Œï¼ˆ52å¼ æ ‡å‡†ç‰Œ+2å¼ ç‹ç‰Œï¼‰ã€‚æ¸¸æˆç›®æ ‡æ˜¯é€šè¿‡å‡ºç‰Œæ¥æˆä¸ºç¬¬ä¸€ä¸ªå‡ºå®Œæ‰‹ä¸­æ‰€æœ‰ç‰Œçš„ç©å®¶ã€‚

## æ¸¸æˆè§„åˆ™

### åŸºæœ¬è§„åˆ™
- **ç©å®¶äººæ•°**: 3äººï¼ˆä¸€æ–¹åœ°ä¸»ï¼Œä¸¤æ–¹å†œæ°‘ï¼‰
- **ç‰Œæ•°**: 54å¼ ï¼ˆåŒ…æ‹¬å¤§å°ç‹ï¼‰
- **å‘ç‰Œ**: æ¯äºº17å¼ ï¼Œå‰©ä½™3å¼ ä½œä¸ºåº•ç‰Œ
- **åœ°ä¸»**: é€šè¿‡æŠ¢åœ°ä¸»æˆ–å«åœ°ä¸»å†³å®š
- **è·èƒœæ¡ä»¶**: å…ˆå‡ºå®Œæ‰€æœ‰ç‰Œçš„ä¸€æ–¹è·èƒœ

### ç‰Œå‹è§„åˆ™
1. **å•ç‰Œ**: ä¸€å¼ ç‰Œ
2. **å¯¹å­**: ä¸¤å¼ ç›¸åŒç‚¹æ•°çš„ç‰Œ
3. **ä¸‰æ¡**: ä¸‰å¼ ç›¸åŒç‚¹æ•°çš„ç‰Œ
4. **ä¸‰å¸¦ä¸€**: ä¸‰å¼ ç›¸åŒç‚¹æ•°çš„ç‰Œ+ä¸€å¼ å•ç‰Œ
5. **ä¸‰å¸¦å¯¹**: ä¸‰å¼ ç›¸åŒç‚¹æ•°çš„ç‰Œ+ä¸€å¯¹
6. **é¡ºå­**: äº”å¼ æˆ–æ›´å¤šè¿ç»­ç‚¹æ•°çš„ç‰Œ
7. **è¿å¯¹**: ä¸‰å¯¹æˆ–æ›´å¤šè¿ç»­å¯¹å­
8. **é£æœº**: ä¸¤ç»„æˆ–æ›´å¤šè¿ç»­ä¸‰æ¡
9. **ç‚¸å¼¹**: å››å¼ ç›¸åŒç‚¹æ•°çš„ç‰Œ
10. **ç‹ç‚¸**: å¤§å°ç‹ç»„åˆ

### ç‰Œå‹å¤§å°æ¯”è¾ƒ
- å•ç‰Œ: 2 > A > K > Q > J > 10 > 9 > 8 > 7 > 6 > 5 > 4 > 3
- é¡ºå­: æŒ‰æœ€å¤§ç‰Œæ¯”è¾ƒ
- ç‚¸å¼¹ > ä»»ä½•ç‰Œå‹
- ç‹ç‚¸ > ä»»ä½•ç‚¸å¼¹

## æ¸¸æˆæµç¨‹è®¾è®¡

```mermaid
graph TB
    A[ç”¨æˆ·è¿›å…¥å¤§å…] --> B[æŸ¥çœ‹æˆ¿é—´åˆ—è¡¨]
    B --> C[åˆ›å»ºæˆ¿é—´æˆ–åŠ å…¥æˆ¿é—´]
    C --> D[ç­‰å¾…å…¶ä»–ç©å®¶åŠ å…¥]

    D --> E{ç©å®¶äººæ•°æ»¡3äºº?}
    E -->|å¦| D
    E -->|æ˜¯| F[æ‰€æœ‰ç©å®¶å‡†å¤‡]

    F --> G{æ‰€æœ‰ç©å®¶å‡†å¤‡å®Œæ¯•?}
    G -->|å¦| F
    G -->|æ˜¯| H[ç³»ç»Ÿå‘ç‰Œ]

    H --> I[æŠ¢åœ°ä¸»é˜¶æ®µ]
    I --> J[ç¡®å®šåœ°ä¸»ç©å®¶]
    J --> K[åœ°ä¸»è·å¾—åº•ç‰Œ]

    K --> L[æ¸¸æˆå¼€å§‹å‡ºç‰Œ]
    L --> M{ç©å®¶å‡ºç‰Œ}
    M --> N{æœ‰ç©å®¶å‡ºå®Œç‰Œ?}
    N -->|å¦| L
    N -->|æ˜¯| O[æ¸¸æˆç»“æŸ]

    O --> P[æ˜¾ç¤ºæ¸¸æˆç»“æœ]
    P --> Q[è¿”å›å¤§å…æˆ–é‡æ–°å¼€å§‹]
```

## ç©å®¶çŠ¶æ€æœº

```mermaid
stateDiagram-v2
    [*] --> åœ¨çº¿: ç”¨æˆ·ç™»å½•
    åœ¨çº¿ --> æˆ¿é—´ä¸­: è¿›å…¥æˆ¿é—´
    æˆ¿é—´ä¸­ --> å‡†å¤‡ä¸­: ç‚¹å‡»å‡†å¤‡æŒ‰é’®
    å‡†å¤‡ä¸­ --> æ¸¸æˆä¸­: æ¸¸æˆå¼€å§‹
    æ¸¸æˆä¸­ --> æ¸¸æˆç»“æŸ: æŸç©å®¶è·èƒœ
    æ¸¸æˆç»“æŸ --> åœ¨çº¿: è¿”å›å¤§å…
    æˆ¿é—´ä¸­ --> åœ¨çº¿: ç¦»å¼€æˆ¿é—´
    æ¸¸æˆä¸­ --> åœ¨çº¿: æ–­çº¿é‡è¿
```

## å‰åç«¯æ¶æ„è®¾è®¡

### æŠ€æœ¯æ ˆ
- **å‰ç«¯**: HTML5 + CSS3 + JavaScript + Socket.IOå®¢æˆ·ç«¯
- **åç«¯**: Node.js + Express + Socket.IOæœåŠ¡ç«¯
- **æ•°æ®åº“**: æš‚æ— éœ€æŒä¹…åŒ–å­˜å‚¨ï¼ˆå†…å­˜å­˜å‚¨ï¼‰
- **éƒ¨ç½²**: å•æœºéƒ¨ç½²ï¼Œæ”¯æŒå¤šäººåŒæ—¶åœ¨çº¿

### ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    subgraph "å®¢æˆ·ç«¯å±‚"
        A[Webæµè§ˆå™¨]
        B[æ¸¸æˆç•Œé¢]
        C[Socket.IOå®¢æˆ·ç«¯]
    end

    subgraph "æœåŠ¡ç«¯å±‚"
        D[ExpressæœåŠ¡å™¨]
        E[Socket.IOæœåŠ¡ç«¯]
        F[æ¸¸æˆé€»è¾‘å¼•æ“]
        G[æˆ¿é—´ç®¡ç†å™¨]
        H[ç‰Œå±€çŠ¶æ€æœº]
    end

    subgraph "æ•°æ®å±‚"
        I[å†…å­˜å­˜å‚¨]
        J[æ¸¸æˆæˆ¿é—´æ•°æ®]
        K[ç©å®¶çŠ¶æ€æ•°æ®]
    end

    A -->|HTTPè¯·æ±‚| D
    A -->|WebSocketè¿æ¥| E
    B -->|æ¸¸æˆæ“ä½œ| C
    C -->|æ¶ˆæ¯ä¼ é€’| E
    E -->|ä¸šåŠ¡é€»è¾‘| F
    F -->|çŠ¶æ€ç®¡ç†| G
    G -->|ç‰Œå±€æ§åˆ¶| H
    H -->|æ•°æ®æŒä¹…åŒ–| I
    I --> J
    I --> K
```

## æ•°æ®ç»“æ„è®¾è®¡

### æˆ¿é—´æ•°æ®ç»“æ„
```typescript
interface GameRoom {
  id: string;                    // æˆ¿é—´å”¯ä¸€æ ‡è¯†
  name: string;                  // æˆ¿é—´åç§°
  players: Player[];             // ç©å®¶åˆ—è¡¨
  maxPlayers: number;            // æœ€å¤§ç©å®¶æ•°
  status: 'waiting' | 'playing' | 'finished';
  currentPlayerIndex: number;    // å½“å‰å‡ºç‰Œç©å®¶ç´¢å¼•
  landlord: Player | null;       // åœ°ä¸»ç©å®¶
  cards: {
    remaining: Card[];           // å‰©ä½™åº•ç‰Œ
    played: Card[][];           // å·²å‡ºç‰Œå†å²
    lastPlayed?: Card[];        // æœ€åå‡ºç‰Œ
  };
  createdAt: Date;
  updatedAt: Date;
}
```

### ç©å®¶æ•°æ®ç»“æ„
```typescript
interface Player {
  id: string;                    // ç©å®¶å”¯ä¸€æ ‡è¯†
  name: string;                  // ç©å®¶æ˜µç§°
  avatar?: string;               // å¤´åƒ
  isReady: boolean;              // æ˜¯å¦å‡†å¤‡
  isOnline: boolean;             // æ˜¯å¦åœ¨çº¿
  cards?: Card[];                // æ‰‹ç‰Œ
  seatIndex?: number;            // åº§ä½å·
}
```

### ç‰Œå‹æ•°æ®ç»“æ„
```typescript
interface Card {
  suit: 'hearts' | 'diamonds' | 'clubs' | 'spades';
  rank: '3' | '4' | '5' | '6' | '7' | '8' | '9' | '10' | 'J' | 'Q' | 'K' | 'A' | '2';
  value: number;                 // ç‰Œå€¼ï¼ˆç”¨äºæ¯”è¾ƒï¼‰
}

interface CardCombination {
  type: 'single' | 'pair' | 'three' | 'three_with_one' | 'three_with_pair' |
        'straight' | 'consecutive_pairs' | 'airplane' | 'bomb' | 'rocket';
  cards: Card[];
  value: number;                 // ç‰Œå‹å¤§å°å€¼
}
```

## å‰åç«¯æ¶ˆæ¯äº¤äº’è®¾è®¡

### WebSocketäº‹ä»¶å®šä¹‰

#### å®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯äº‹ä»¶
```typescript
interface ClientToServerEvents {
  // æˆ¿é—´ç®¡ç†
  join_room: (roomId: string, playerName: string) => void;
  leave_room: () => void;
  ready: () => void;

  // æ¸¸æˆæµç¨‹
  grab_landlord: (isGrab: boolean) => void;
  play_cards: (cards: Card[]) => void;
  pass_turn: () => void;

  // èŠå¤©åŠŸèƒ½
  send_message: (message: string) => void;
}
```

#### æœåŠ¡ç«¯åˆ°å®¢æˆ·ç«¯äº‹ä»¶
```typescript
interface ServerToClientEvents {
  // æˆ¿é—´çŠ¶æ€
  room_joined: (room: GameRoom) => void;
  room_left: (roomId: string) => void;
  player_joined: (player: Player) => void;
  player_left: (playerId: string) => void;
  room_state_updated: (room: GameRoom) => void;

  // æ¸¸æˆæµç¨‹
  game_started: (gameRoom: GameRoom) => void;
  cards_dealt: (cards: Card[]) => void;
  landlord_selected: (landlord: Player, bottomCards: Card[]) => void;
  turn_changed: (nextPlayerId: string, lastPlayed?: Card[]) => void;
  cards_played: (playerId: string, cards: Card[]) => void;
  game_ended: (winner: Player, reason: string) => void;

  // èŠå¤©åŠŸèƒ½
  message_received: (playerName: string, message: string) => void;
  error: (message: string) => void;
}
```

### HTTP APIæ¥å£è®¾è®¡

#### æˆ¿é—´ç®¡ç†API
```
GET    /api/games/rooms           # è·å–æ‰€æœ‰æˆ¿é—´åˆ—è¡¨
POST   /api/games/rooms           # åˆ›å»ºæ–°æˆ¿é—´
GET    /api/games/rooms/:roomId   # è·å–æˆ¿é—´è¯¦æƒ…
```

#### æ¸¸æˆæ§åˆ¶API
```
POST   /api/games/rooms/:roomId/join    # åŠ å…¥æˆ¿é—´
POST   /api/games/rooms/:roomId/ready   # ç©å®¶å‡†å¤‡
POST   /api/games/rooms/:roomId/leave   # ç¦»å¼€æˆ¿é—´
```

## æ¸¸æˆé€»è¾‘å®ç°æŒ‡å—

### 1. æˆ¿é—´ç®¡ç†ç³»ç»Ÿ
- æˆ¿é—´åˆ›å»ºä¸é”€æ¯
- ç©å®¶åŠ å…¥/ç¦»å¼€å¤„ç†
- æˆ¿é—´çŠ¶æ€åŒæ­¥

### 2. ç‰Œå±€æ§åˆ¶å¼•æ“
- æ´—ç‰Œå‘ç‰Œç®—æ³•
- ç‰Œå‹è¯†åˆ«ä¸æ¯”è¾ƒ
- å‡ºç‰Œåˆæ³•æ€§éªŒè¯
- æ¸¸æˆçŠ¶æ€ç®¡ç†

### 3. æŠ¢åœ°ä¸»æœºåˆ¶
- æŠ¢åœ°ä¸»è½®æ¬¡æ§åˆ¶
- åœ°ä¸»ç¡®å®šé€»è¾‘
- åº•ç‰Œåˆ†é…

### 4. å‡ºç‰Œé€»è¾‘
- ç‰Œå‹éªŒè¯ç®—æ³•
- ç‰Œå‹å¤§å°æ¯”è¾ƒ
- å‡ºç‰Œé¡ºåºæ§åˆ¶
- æ¸¸æˆç»“æŸåˆ¤æ–­

## ç”¨æˆ·ç•Œé¢è®¾è®¡

### 1. å¤§å…ç•Œé¢
- æˆ¿é—´åˆ—è¡¨å±•ç¤º
- åˆ›å»ºæˆ¿é—´è¡¨å•
- å¿«é€ŸåŠ å…¥åŠŸèƒ½

### 2. æˆ¿é—´ç•Œé¢
- ç©å®¶åº§ä½å¸ƒå±€
- å‡†å¤‡çŠ¶æ€æ˜¾ç¤º
- æ¸¸æˆæ§åˆ¶æŒ‰é’®
- èŠå¤©åŒºåŸŸ

### 3. æ¸¸æˆç•Œé¢
- æ‰‹ç‰Œå±•ç¤ºåŒºåŸŸ
- å‡ºç‰ŒåŒºåŸŸ
- å…¶ä»–ç©å®¶ç‰Œæ•°æ˜¾ç¤º
- æ¸¸æˆæ“ä½œæŒ‰é’®ï¼ˆå‡ºç‰Œã€æç¤ºã€è·³è¿‡ï¼‰

## å®‰å…¨æ€§è€ƒè™‘

1. **è¾“å…¥éªŒè¯**: æ‰€æœ‰ç”¨æˆ·è¾“å…¥éœ€éªŒè¯åˆæ³•æ€§
2. **çŠ¶æ€åŒæ­¥**: æœåŠ¡ç«¯æƒå¨ï¼Œå®¢æˆ·ç«¯åŒæ­¥
3. **é˜²ä½œå¼Š**: å‡ºç‰ŒéªŒè¯ã€ç‰Œå‹æ£€æŸ¥
4. **è¿æ¥ç®¡ç†**: å¤„ç†æ–­çº¿é‡è¿

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å†…å­˜ç®¡ç†**: å®šæœŸæ¸…ç†æ— ç”¨æˆ¿é—´æ•°æ®
2. **å¹¶å‘æ§åˆ¶**: ä½¿ç”¨é”æœºåˆ¶é¿å…ç«æ€æ¡ä»¶
3. **æ¶ˆæ¯å‹ç¼©**: WebSocketæ¶ˆæ¯ä½“é‡æ§åˆ¶
4. **ç¼“å­˜ç­–ç•¥**: å¸¸ç”¨æ•°æ®ç¼“å­˜

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
- ç‰Œå‹è¯†åˆ«ç®—æ³•
- å‡ºç‰Œåˆæ³•æ€§éªŒè¯
- æ¸¸æˆçŠ¶æ€è½¬æ¢

### é›†æˆæµ‹è¯•
- å®Œæ•´æ¸¸æˆæµç¨‹
- å¤šç©å®¶äº’åŠ¨
- ç½‘ç»œå¼‚å¸¸å¤„ç†

### ç”¨æˆ·ä½“éªŒæµ‹è¯•
- ç•Œé¢äº¤äº’æµç•…æ€§
- å“åº”é€Ÿåº¦æµ‹è¯•
- å…¼å®¹æ€§æµ‹è¯•

## æ¶ˆæ¯äº¤äº’è¯¦ç»†è®¾è®¡

### 1. ç”¨æˆ·è¿›å…¥æ¸¸æˆæµç¨‹äº¤äº’æ—¶åº

```mermaid
sequenceDiagram
    participant C as å®¢æˆ·ç«¯æµè§ˆå™¨
    participant S as æœåŠ¡ç«¯
    participant DB as å†…å­˜å­˜å‚¨

    Note over C: ç”¨æˆ·æ‰“å¼€æ¸¸æˆé¡µé¢
    C->>S: HTTP GET / (åŠ è½½é¡µé¢)
    S-->>C: è¿”å›HTMLé¡µé¢

    Note over C: ç”¨æˆ·è¿›å…¥å¤§å…
    C->>S: HTTP GET /api/games/rooms (è·å–æˆ¿é—´åˆ—è¡¨)
    S-->>C: è¿”å›æˆ¿é—´åˆ—è¡¨æ•°æ®

    Note over C: ç”¨æˆ·é€‰æ‹©æˆ¿é—´æˆ–åˆ›å»ºæˆ¿é—´
    alt ç”¨æˆ·åŠ å…¥æˆ¿é—´
        C->>S: HTTP POST /api/games/rooms/:roomId/join
        S-->>C: è¿”å›åŠ å…¥ç»“æœ
    else ç”¨æˆ·åˆ›å»ºæˆ¿é—´
        C->>S: HTTP POST /api/games/rooms
        S-->>C: è¿”å›æ–°æˆ¿é—´ä¿¡æ¯
    end

    Note over C,S: å»ºç«‹WebSocketè¿æ¥
    C->>S: Socket.IOè¿æ¥å»ºç«‹
    S-->>C: è¿æ¥æˆåŠŸç¡®è®¤

    C->>S: join_room (æˆ¿é—´ID, ç©å®¶åç§°)
    S-->>DB: ä¿å­˜ç©å®¶ä¿¡æ¯åˆ°æˆ¿é—´
    S-->>C: room_joined (æˆ¿é—´ä¿¡æ¯)
    S-->>C: room_state_updated (å½“å‰æˆ¿é—´çŠ¶æ€)

    Note over C: æˆ¿é—´å†…ç©å®¶äº’åŠ¨
    C->>S: ready (å‡†å¤‡æ¸¸æˆ)
    S-->>DB: æ›´æ–°ç©å®¶å‡†å¤‡çŠ¶æ€
    S-->>C: room_state_updated (æ›´æ–°æˆ¿é—´çŠ¶æ€)

    Note over S: æ£€æŸ¥æ¸¸æˆå¼€å§‹æ¡ä»¶
    S-->>S: æ‰€æœ‰ç©å®¶å‡†å¤‡ä¸”æ»¡3äººï¼Ÿ
    S-->>S: å¼€å§‹æ¸¸æˆé€»è¾‘

    S-->>C: game_started (æ¸¸æˆå¼€å§‹)
    S-->>C: cards_dealt (å‘ç‰Œæ•°æ®)
    S-->>C: turn_changed (è½®åˆ°è°å‡ºç‰Œ)
```

### 2. æ¸¸æˆè¿›è¡Œä¸­äº¤äº’æ—¶åº

```mermaid
sequenceDiagram
    participant P1 as ç©å®¶1
    participant P2 as ç©å®¶2
    participant P3 as ç©å®¶3
    participant S as æœåŠ¡ç«¯

    Note over S: æ¸¸æˆå¼€å§‹ï¼Œå‘ç‰Œå®Œæˆ
    S->>P1: cards_dealt (æ‰‹ç‰Œæ•°æ®)
    S->>P2: cards_dealt (æ‰‹ç‰Œæ•°æ®)
    S->>P3: cards_dealt (æ‰‹ç‰Œæ•°æ®)

    Note over P1: è½®åˆ°ç©å®¶1å‡ºç‰Œ
    S->>P1: turn_changed (ä½ çš„å›åˆ)
    S->>P2: turn_changed (ç­‰å¾…ç©å®¶1å‡ºç‰Œ)
    S->>P3: turn_changed (ç­‰å¾…ç©å®¶1å‡ºç‰Œ)

    P1->>S: play_cards (é€‰æ‹©çš„ç‰Œ)
    S-->>S: éªŒè¯ç‰Œå‹åˆæ³•æ€§
    S-->>S: æ¯”è¾ƒç‰Œå‹å¤§å°
    alt ç‰Œå‹åˆæ³•
        S-->>DB: æ›´æ–°æ¸¸æˆçŠ¶æ€
        S->>P1: æˆåŠŸå‡ºç‰Œç¡®è®¤
        S->>P2: cards_played (ç©å®¶1å‡ºçš„ç‰Œ)
        S->>P3: cards_played (ç©å®¶1å‡ºçš„ç‰Œ)

        Note over S: åˆ¤æ–­æ¸¸æˆæ˜¯å¦ç»“æŸ
        alt ç©å®¶1å‡ºå®Œç‰Œ
            S->>P1: game_ended (ä½ è·èƒœ)
            S->>P2: game_ended (ç©å®¶1è·èƒœ)
            S->>P3: game_ended (ç©å®¶1è·èƒœ)
        else ç‰Œæœªå‡ºå®Œ
            Note over P2: è½®åˆ°ç©å®¶2å‡ºç‰Œ
            S->>P2: turn_changed (ä½ çš„å›åˆ)
            S->>P1: turn_changed (ç­‰å¾…ç©å®¶2å‡ºç‰Œ)
            S->>P3: turn_changed (ç­‰å¾…ç©å®¶2å‡ºç‰Œ)
        end
    else ç‰Œå‹ä¸åˆæ³•
        S->>P1: error (å‡ºç‰Œæ— æ•ˆ)
    end
```

### 3. æŠ¢åœ°ä¸»é˜¶æ®µäº¤äº’æ—¶åº

```mermaid
sequenceDiagram
    participant P1 as ç©å®¶1
    participant P2 as ç©å®¶2
    participant P3 as ç©å®¶3
    participant S as æœåŠ¡ç«¯

    Note over S: æ¸¸æˆå¼€å§‹ï¼Œå‘ç‰Œå®Œæˆ
    S->>P1: game_started (æ¸¸æˆå¼€å§‹)
    S->>P2: game_started (æ¸¸æˆå¼€å§‹)
    S->>P3: game_started (æ¸¸æˆå¼€å§‹)

    Note over P1,P2,P3: æŠ¢åœ°ä¸»é˜¶æ®µå¼€å§‹
    S->>P1: landlord_selection (è½®åˆ°ä½ æŠ¢åœ°ä¸»)
    S->>P2: landlord_selection (ç­‰å¾…ç©å®¶1é€‰æ‹©)
    S->>P3: landlord_selection (ç­‰å¾…ç©å®¶1é€‰æ‹©)

    P1->>S: grab_landlord (true/false)
    alt ç©å®¶1æŠ¢åœ°ä¸»
        S-->>S: ç©å®¶1æˆä¸ºåœ°ä¸»
        S->>P1: landlord_selected (ä½ æ˜¯åœ°ä¸»)
        S->>P2: landlord_selected (ç©å®¶1æ˜¯åœ°ä¸»)
        S->>P3: landlord_selected (ç©å®¶1æ˜¯åœ°ä¸»)
        S->>P1: cards_dealt (åº•ç‰Œ)
    else ç©å®¶1ä¸æŠ¢
        S->>P2: landlord_selection (è½®åˆ°ä½ æŠ¢åœ°ä¸»)
        S->>P1: landlord_selection (ç­‰å¾…ç©å®¶2é€‰æ‹©)
        S->>P3: landlord_selection (ç­‰å¾…ç©å®¶2é€‰æ‹©)

        P2->>S: grab_landlord (true/false)
        alt ç©å®¶2æŠ¢åœ°ä¸»
            S-->>S: ç©å®¶2æˆä¸ºåœ°ä¸»
            S->>P2: landlord_selected (ä½ æ˜¯åœ°ä¸»)
            S->>P1: landlord_selected (ç©å®¶2æ˜¯åœ°ä¸»)
            S->>P3: landlord_selected (ç©å®¶2æ˜¯åœ°ä¸»)
            S->>P2: cards_dealt (åº•ç‰Œ)
        else ç©å®¶2ä¸æŠ¢
            S->>P3: landlord_selection (è½®åˆ°ä½ æŠ¢åœ°ä¸»)
            S->>P1: landlord_selection (ç­‰å¾…ç©å®¶3é€‰æ‹©)
            S->>P2: landlord_selection (ç­‰å¾…ç©å®¶3é€‰æ‹©)

            P3->>S: grab_landlord (true/false)
            alt ç©å®¶3æŠ¢åœ°ä¸»
                S-->>S: ç©å®¶3æˆä¸ºåœ°ä¸»
                S->>P3: landlord_selected (ä½ æ˜¯åœ°ä¸»)
                S->>P1: landlord_selected (ç©å®¶3æ˜¯åœ°ä¸»)
                S->>P2: landlord_selected (ç©å®¶3æ˜¯åœ°ä¸»)
                S->>P3: cards_dealt (åº•ç‰Œ)
            else ç©å®¶3ä¸æŠ¢
                Note over S: é‡æ–°å‘ç‰Œæˆ–ç»“æŸæ¸¸æˆ
            end
        end
    end
```

### 4. èŠå¤©ç³»ç»Ÿäº¤äº’æ—¶åº

```mermaid
sequenceDiagram
    participant P1 as ç©å®¶1
    participant P2 as ç©å®¶2
    participant S as æœåŠ¡ç«¯

    P1->>S: send_message (èŠå¤©å†…å®¹)
    S-->>S: éªŒè¯æ¶ˆæ¯åˆæ³•æ€§
    alt æ¶ˆæ¯åˆæ³•
        S->>P1: message_sent (å‘é€æˆåŠŸ)
        S->>P2: message_received (ç©å®¶1çš„æ¶ˆæ¯)
        S->>P3: message_received (ç©å®¶1çš„æ¶ˆæ¯)
    else æ¶ˆæ¯éæ³•
        S->>P1: error (æ¶ˆæ¯å‘é€å¤±è´¥)
    end
```

### 5. æ–­çº¿é‡è¿å¤„ç†æ—¶åº

```mermaid
sequenceDiagram
    participant P1 as æ–­çº¿ç©å®¶
    participant S as æœåŠ¡ç«¯
    participant P2 as ç©å®¶2
    participant P3 as ç©å®¶3

    Note over P1: ç©å®¶1æ–­çº¿é‡è¿
    P1->>S: Socket.IOé‡è¿
    S-->>S: éªŒè¯ç©å®¶èº«ä»½

    alt æ¸¸æˆè¿›è¡Œä¸­
        S->>P1: game_state_sync (å½“å‰æ¸¸æˆçŠ¶æ€)
        S->>P1: cards_sync (æ‰‹ç‰Œæ•°æ®)
        S->>P1: turn_sync (å½“å‰å‡ºç‰Œç©å®¶)
        S-->>P2: player_reconnected (ç©å®¶1é‡è¿)
        S-->>P3: player_reconnected (ç©å®¶1é‡è¿)
    else æ¸¸æˆæœªå¼€å§‹
        S->>P1: room_state_sync (æˆ¿é—´çŠ¶æ€)
        S-->>P2: player_reconnected (ç©å®¶1é‡è¿)
        S-->>P3: player_reconnected (ç©å®¶1é‡è¿)
    end
```

## æ¶ˆæ¯æ ¼å¼å®šä¹‰

### WebSocketæ¶ˆæ¯æ ¼å¼

#### å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯æ ¼å¼
```typescript
// åŠ å…¥æˆ¿é—´
{
  type: 'join_room',
  data: {
    roomId: string,
    playerName: string
  }
}

// å‡ºç‰Œ
{
  type: 'play_cards',
  data: {
    cards: Card[],
    roomId: string
  }
}

// èŠå¤©
{
  type: 'send_message',
  data: {
    message: string,
    roomId: string
  }
}
```

#### æœåŠ¡ç«¯å¹¿æ’­æ¶ˆæ¯æ ¼å¼
```typescript
// æˆ¿é—´çŠ¶æ€æ›´æ–°
{
  type: 'room_state_updated',
  data: {
    room: GameRoom
  }
}

// å‡ºç‰Œé€šçŸ¥
{
  type: 'cards_played',
  data: {
    playerId: string,
    playerName: string,
    cards: Card[]
  }
}

// æ¸¸æˆç»“æŸ
{
  type: 'game_ended',
  data: {
    winner: Player,
    reason: string,
    gameStats: {
      totalRounds: number,
      duration: number
    }
  }
}
```

### HTTP APIå“åº”æ ¼å¼

#### ç»Ÿä¸€å“åº”æ ¼å¼
```typescript
{
  success: boolean,
  data?: any,
  message?: string,
  error?: string,
  timestamp: string
}
```

#### åˆ†é¡µå“åº”æ ¼å¼
```typescript
{
  success: true,
  data: {
    items: any[],
    pagination: {
      currentPage: number,
      pageSize: number,
      total: number,
      totalPages: number
    }
  }
}
```

## é”™è¯¯å¤„ç†æœºåˆ¶

### é”™è¯¯ç±»å‹åˆ†ç±»
1. **ç½‘ç»œé”™è¯¯**: è¿æ¥æ–­å¼€ã€è¶…æ—¶ç­‰
2. **ä¸šåŠ¡é€»è¾‘é”™è¯¯**: å‡ºç‰Œéæ³•ã€æ“ä½œæ— æ•ˆç­‰
3. **ç³»ç»Ÿé”™è¯¯**: æœåŠ¡ç«¯å¼‚å¸¸ã€æ•°æ®åº“é”™è¯¯ç­‰

### é”™è¯¯å“åº”æ ¼å¼
```typescript
{
  success: false,
  error: {
    code: string,        // é”™è¯¯ä»£ç 
    message: string,     // é”™è¯¯ä¿¡æ¯
    details?: any        // è¯¦ç»†é”™è¯¯ä¿¡æ¯
  },
  timestamp: string
}
```

### å¸¸è§é”™è¯¯ç å®šä¹‰
- `INVALID_CARDS`: å‡ºç‰Œä¸ç¬¦åˆè§„åˆ™
- `NOT_YOUR_TURN`: æœªè½®åˆ°è¯¥ç©å®¶å‡ºç‰Œ
- `ROOM_FULL`: æˆ¿é—´å·²æ»¡
- `GAME_ALREADY_STARTED`: æ¸¸æˆå·²å¼€å§‹
- `INVALID_ROOM`: æˆ¿é—´ä¸å­˜åœ¨
- `PLAYER_NOT_FOUND`: ç©å®¶ä¸å­˜åœ¨

## ç‰Œå‹è¯†åˆ«ç®—æ³•è®¾è®¡

### ç‰Œå€¼æ˜ å°„è¡¨
```typescript
const CARD_VALUES = {
  '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, '10': 10,
  'J': 11, 'Q': 12, 'K': 13, 'A': 14, '2': 15,
  'ğŸƒ': 16,  // å°ç‹
  'ğŸ‚ ': 17   // å¤§ç‹
};

const CARD_RANKS = ['3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A', '2', 'ğŸƒ', 'ğŸ‚ '];
```

### ç‰Œå‹è¯†åˆ«å‡½æ•°
```typescript
interface CardCombination {
  type: string;
  value: number;
  cards: Card[];
}

function identifyCardCombination(cards: Card[]): CardCombination | null {
  if (cards.length === 0) return null;

  // æŒ‰ç‰Œå€¼æ’åº
  const sortedCards = [...cards].sort((a, b) => CARD_VALUES[a.rank] - CARD_VALUES[b.rank]);

  // å•ç‰Œ
  if (cards.length === 1) {
    return { type: 'single', value: CARD_VALUES[cards[0].rank], cards };
  }

  // å¯¹å­
  if (cards.length === 2 && cards[0].rank === cards[1].rank) {
    return { type: 'pair', value: CARD_VALUES[cards[0].rank], cards };
  }

  // ä¸‰æ¡
  if (cards.length === 3 && cards.every(card => card.rank === cards[0].rank)) {
    return { type: 'three', value: CARD_VALUES[cards[0].rank], cards };
  }

  // ä¸‰å¸¦ä¸€
  if (cards.length === 4) {
    const values = [...new Set(cards.map(card => card.rank))];
    if (values.length === 2) {
      const threeValue = values.find(v => cards.filter(c => c.rank === v).length === 3);
      if (threeValue) {
        return { type: 'three_with_one', value: CARD_VALUES[threeValue], cards };
      }
    }
  }

  // ä¸‰å¸¦å¯¹
  if (cards.length === 5) {
    const values = [...new Set(cards.map(card => card.rank))];
    if (values.length === 2) {
      const threeValue = values.find(v => cards.filter(c => c.rank === v).length === 3);
      if (threeValue) {
        return { type: 'three_with_pair', value: CARD_VALUES[threeValue], cards };
      }
    }
  }

  // é¡ºå­
  if (cards.length >= 5 && cards.length <= 12) {
    const isStraight = sortedCards.every((card, index) =>
      index === 0 || CARD_VALUES[card.rank] === CARD_VALUES[sortedCards[index - 1].rank] + 1
    );
    if (isStraight && CARD_VALUES[sortedCards[0].rank] >= 3 && CARD_VALUES[sortedCards[cards.length - 1].rank] <= 14) {
      return { type: 'straight', value: CARD_VALUES[sortedCards[cards.length - 1].rank], cards };
    }
  }

  // è¿å¯¹
  if (cards.length >= 6 && cards.length % 2 === 0) {
    const pairs = [];
    for (let i = 0; i < cards.length; i += 2) {
      if (cards[i].rank !== cards[i + 1].rank) break;
      pairs.push(cards[i].rank);
    }
    if (pairs.length === cards.length / 2 && pairs.length >= 3) {
      const isConsecutivePairs = pairs.every((pair, index) =>
        index === 0 || CARD_VALUES[pair] === CARD_VALUES[pairs[index - 1]] + 1
      );
      if (isConsecutivePairs) {
        return { type: 'consecutive_pairs', value: CARD_VALUES[pairs[pairs.length - 1]], cards };
      }
    }
  }

  // é£æœºï¼ˆè¿ç»­ä¸‰æ¡ï¼‰
  if (cards.length >= 6 && cards.length % 3 === 0) {
    const groups = [];
    for (let i = 0; i < cards.length; i += 3) {
      if (cards[i].rank !== cards[i + 1].rank || cards[i].rank !== cards[i + 2].rank) break;
      groups.push(cards[i].rank);
    }
    if (groups.length === cards.length / 3 && groups.length >= 2) {
      const isConsecutive = groups.every((group, index) =>
        index === 0 || CARD_VALUES[group] === CARD_VALUES[groups[index - 1]] + 1
      );
      if (isConsecutive) {
        return { type: 'airplane', value: CARD_VALUES[groups[groups.length - 1]], cards };
      }
    }
  }

  // ç‚¸å¼¹
  if (cards.length === 4 && cards.every(card => card.rank === cards[0].rank)) {
    return { type: 'bomb', value: CARD_VALUES[cards[0].rank], cards };
  }

  // ç‹ç‚¸
  if (cards.length === 2 && cards.some(card => card.rank === 'ğŸƒ') && cards.some(card => card.rank === 'ğŸ‚ ')) {
    return { type: 'rocket', value: 999, cards };
  }

  return null;
}
```

è¿™ä»½è®¾è®¡æ–‡æ¡£ä¸ºæ–—åœ°ä¸»æ¸¸æˆçš„å®Œæ•´å¼€å‘æä¾›äº†è¯¦ç»†çš„æŠ€æœ¯æŒ‡å¯¼ï¼Œæ¶µç›–äº†æ¸¸æˆè§„åˆ™ã€ç³»ç»Ÿæ¶æ„ã€ç®—æ³•è®¾è®¡ã€å‰åç«¯äº¤äº’åè®®ã€ç”¨æˆ·ç•Œé¢è®¾è®¡ã€æ€§èƒ½ä¼˜åŒ–ç­‰å„ä¸ªæ–¹é¢ã€‚å¼€å‘å›¢é˜Ÿå¯ä»¥ä¾æ®æ­¤æ–‡æ¡£è¿›è¡Œé«˜æ•ˆçš„å¼€å‘å·¥ä½œã€‚
