# 🚀 上线前最终检查清单

## ✅ 代码一致性检查（已完成）

### 前端
- [x] `global-socket.js` - 使用MPA架构，`connect()` 方法
- [x] `login.js` - 调用 `connect(userName, userId)`
- [x] `lobby.js` - 调用 `connect()` 无参数
- [x] `room-simple.js` - 调用 `connect()` 无参数
- [x] 所有日志标记统一为 `[MPA]`
- [x] 所有注释更新为多页面架构
- [x] 无遗留的 `getSocket()` 调用

### 后端
- [x] `userManager.ts` - 500ms时间窗口逻辑
- [x] `AuthMiddleware.ts` - 断开连接时设置离线
- [x] 所有日志标记统一为 `[MPA]`

---

## 🧪 功能测试清单

### 1. 基础登录流程
- [ ] 玩家A登录 → 进入大厅
- [ ] 玩家B登录 → 进入大厅
- [ ] 玩家C登录 → 进入大厅
- [ ] 检查后端日志：3个用户成功注册

### 2. 房间功能
- [ ] 玩家A加入房间A05
- [ ] 玩家B加入房间A05
- [ ] 玩家C加入房间A05
- [ ] 检查：3个玩家都能看到彼此
- [ ] 检查：房间列表显示3/3

### 3. 准备和开始
- [ ] 3个玩家点击准备
- [ ] 游戏自动开始
- [ ] 发牌正常
- [ ] 底牌显示正常

### 4. 叫地主
- [ ] 第一个玩家可以叫/不叫
- [ ] 第二个玩家可以叫/不叫
- [ ] 第三个玩家可以叫/不叫
- [ ] 地主确定正确
- [ ] 地主获得底牌

### 5. 出牌流程
- [ ] 地主先出牌
- [ ] 轮流出牌正常
- [ ] 不出功能正常
- [ ] 提示功能正常
- [ ] 牌型判断正确

### 6. 游戏结算
- [ ] 游戏结束判断正确
- [ ] 结算页面显示正确
- [ ] 积分计算正确
- [ ] 查看战绩功能正常

### 7. 重复登录保护
- [ ] 窗口A：玩家A登录并保持
- [ ] 窗口B：尝试登录玩家A
- [ ] 预期：窗口B被拒绝，提示"用户名已被占用"

### 8. 页面跳转
- [ ] 登录 → 大厅（无白屏）
- [ ] 大厅 → 房间（无白屏）
- [ ] 房间 → 结算（无白屏）
- [ ] 结算 → 个人中心（无白屏）
- [ ] 返回大厅（无白屏）

### 9. 页面刷新
- [ ] 大厅页面刷新 → 能正常恢复
- [ ] 房间页面刷新 → 能正常恢复（如果在游戏中）

### 10. 断线重连
- [ ] 断开网络
- [ ] 等待5秒
- [ ] 恢复网络
- [ ] 检查：自动重连成功

---

## 🐛 已知问题和解决方案

### 1. 头像显示问题
**状态**: 待修复
**现象**: 其他玩家头像显示为默认头像
**优先级**: 中
**是否影响上线**: 否

### 2. 提示功能
**状态**: 已修复
**修复内容**: 
- 支持拆分对子/三张
- 正确处理单牌提示
- 火箭提示正常

### 3. 查看战绩
**状态**: 已修复
**修复内容**:
- 通过URL参数传递用户信息
- 不依赖localStorage
- 多标签页正常工作

---

## 📝 上线前准备

### 代码准备
- [x] 所有修改已提交
- [x] 代码一致性检查完成
- [x] 无语法错误
- [x] 无明显bug

### 环境准备
- [ ] 后端服务器运行正常
- [ ] 前端静态文件服务正常
- [ ] 端口3000可访问
- [ ] 防火墙配置正确

### 文档准备
- [x] README.md 更新
- [x] TESTING_GUIDE.md 完整
- [x] SPA_VS_MPA_GUIDE.md 详细
- [x] 代码注释清晰

---

## 🚀 上线步骤

### Step 1: 构建后端
```bash
cd backend
npm run build
```

### Step 2: 启动后端
```bash
npm start
```
**检查**: 看到 "Server is running on port 3000"

### Step 3: 访问前端
```
http://localhost:3000
```

### Step 4: 快速冒烟测试
1. 登录3个玩家
2. 加入同一房间
3. 完成一局游戏
4. 检查结算

### Step 5: 完整功能测试
按照上面的功能测试清单逐项测试

---

## ⚠️ 上线注意事项

### 1. 时间窗口设置
当前设置：**500ms**
- 如果页面跳转很慢，可能需要增加到1000ms
- 如果重复登录保护不够严格，可以减少到300ms

修改位置：
```typescript
// backend/src/services/user/userManager.ts
if (timeSinceLastLogin < 500) { // 这里
```

### 2. 日志监控
上线后重点关注：
- `❌ [MPA] 拒绝重复登录` - 是否有误杀
- `✅ [MPA] 页面跳转重连` - 是否正常
- Socket连接/断开频率 - 是否异常

### 3. 性能监控
- Socket连接数
- 内存使用
- CPU使用
- 响应时间

### 4. 用户反馈
重点收集：
- 页面跳转是否流畅
- 是否有"用户名已被占用"误报
- 游戏功能是否正常
- 是否有卡顿或延迟

---

## 🔧 快速问题排查

### 问题1: "用户名已被占用"误报
**原因**: 时间窗口太短
**解决**: 增加时间窗口到1000ms

### 问题2: 重复登录没有被拦截
**原因**: 时间窗口太长
**解决**: 减少时间窗口到300ms

### 问题3: 页面跳转白屏
**原因**: Socket连接慢
**解决**: 
1. 检查网络
2. 增加超时时间
3. 添加加载动画

### 问题4: 游戏中断线
**原因**: Socket断开
**解决**:
1. 检查自动重连是否工作
2. 检查服务器是否稳定
3. 增加重连次数

---

## 📊 成功指标

### 技术指标
- [ ] 3个玩家能同时游戏
- [ ] 页面跳转无错误
- [ ] 重复登录被正确拦截
- [ ] 游戏流程完整

### 用户体验指标
- [ ] 页面跳转流畅（<2秒）
- [ ] 无明显卡顿
- [ ] 错误提示友好
- [ ] 游戏逻辑正确

### 稳定性指标
- [ ] 连续运行1小时无崩溃
- [ ] 10局游戏无异常
- [ ] 内存无泄漏
- [ ] CPU使用正常

---

## ✅ 上线决策

### 可以上线的条件
- ✅ 所有基础功能测试通过
- ✅ 无阻塞性bug
- ✅ 代码一致性检查完成
- ✅ 文档完整

### 需要延期的情况
- ❌ 核心功能无法使用
- ❌ 频繁崩溃
- ❌ 重复登录保护失效
- ❌ 数据丢失

---

## 🎯 上线后计划

### 短期（1周内）
- [ ] 收集用户反馈
- [ ] 修复紧急bug
- [ ] 优化性能
- [ ] 调整时间窗口

### 中期（1个月内）
- [ ] 修复头像显示问题
- [ ] 添加更多功能
- [ ] 优化UI/UX
- [ ] 添加统计功能

### 长期（3个月内）
- [ ] 考虑迁移到SPA
- [ ] 添加排行榜
- [ ] 添加好友系统
- [ ] 移动端适配

---

## 📞 联系方式

如有问题，请查看：
- `TESTING_GUIDE.md` - 测试指南
- `SPA_VS_MPA_GUIDE.md` - 架构说明
- `SINGLE_CONNECTION_IMPACT_ANALYSIS.md` - 影响分析

---

**祝上线顺利！🎉**
