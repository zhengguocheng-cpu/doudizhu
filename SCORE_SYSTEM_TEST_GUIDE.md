# 积分系统测试指南

## 📋 测试概述

**版本**: v1.2.0  
**测试日期**: 2025-10-30  
**测试范围**: 积分记录系统完整功能  

---

## 🎯 测试目标

1. 验证积分正确记录和计算
2. 验证成就系统自动解锁
3. 验证排行榜功能
4. 验证个人中心页面显示
5. 验证游戏结算积分集成

---

## 🚀 启动服务器

### 1. 启动后端
```bash
cd backend
npm run dev
```

### 2. 访问前端
打开浏览器访问: `http://localhost:3000`

---

## 📝 测试步骤

### 测试1: 首次游戏积分记录

#### 步骤
1. 打开浏览器，访问 `http://localhost:3000`
2. 输入玩家名称（例如：玩家A）
3. 选择头像，点击"进入大厅"
4. 创建或加入房间
5. 等待3名玩家准备
6. 完成一局游戏

#### 预期结果
- ✅ 游戏结束时，控制台显示积分记录日志
- ✅ 每个玩家的积分变化正确计算
- ✅ 获胜者积分增加，失败者积分减少
- ✅ 首胜成就自动解锁

#### 验证方法
查看后端控制台输出：
```
📊 玩家A 积分: +4 → 1004
🏆 玩家A 解锁成就: ['first_win']
```

---

### 测试2: 查看个人中心

#### 步骤
1. 游戏结束后，访问 `http://localhost:3000/profile`
2. 查看个人信息卡片
3. 查看统计数据
4. 查看排名信息
5. 查看成就列表
6. 查看游戏历史

#### 预期结果
- ✅ 显示当前积分（初始1000 + 游戏得分）
- ✅ 显示总场次：1
- ✅ 显示胜率：100% 或 0%
- ✅ 显示连胜：1 或 0
- ✅ 显示积分排名
- ✅ 显示已解锁的成就（首胜）
- ✅ 显示最近一场游戏记录

#### 截图示例
```
┌─────────────────────────────┐
│  👤 玩家A                    │
│  ID: player_123             │
├─────────────────────────────┤
│  💰 当前积分: 1004          │
│  📊 总场次: 1               │
│  🏆 胜率: 100.0%            │
│  🔥 连胜: 1                 │
└─────────────────────────────┘
```

---

### 测试3: 多局游戏积分累积

#### 步骤
1. 返回大厅，再玩几局游戏
2. 尝试不同角色（地主/农民）
3. 尝试不同结果（胜/负）
4. 每局结束后查看个人中心

#### 预期结果
- ✅ 积分正确累积
- ✅ 总场次增加
- ✅ 胜率正确计算
- ✅ 连胜正确统计
- ✅ 游戏历史按时间倒序显示

#### 验证公式
```
胜率 = (获胜场次 / 总场次) × 100%
```

---

### 测试4: 成就解锁

#### 步骤
1. 连续赢得3场游戏
2. 查看个人中心成就列表
3. 继续游戏，达到其他成就条件

#### 预期结果
- ✅ 三连胜成就解锁（+30积分奖励）
- ✅ 控制台显示成就解锁日志
- ✅ 个人中心显示已解锁成就
- ✅ 积分自动增加奖励分数

#### 成就列表
| 成就ID | 名称 | 条件 | 奖励 |
|--------|------|------|------|
| first_win | 首胜 | 赢得1场 | +10 |
| win_10 | 小有成就 | 赢得10场 | +50 |
| win_50 | 游戏高手 | 赢得50场 | +200 |
| win_100 | 斗地主大师 | 赢得100场 | +500 |
| streak_3 | 三连胜 | 连胜3场 | +30 |
| streak_5 | 五连胜 | 连胜5场 | +100 |
| streak_10 | 十连胜 | 连胜10场 | +300 |
| score_1000 | 千分玩家 | 积分1000 | +100 |
| score_5000 | 五千分大佬 | 积分5000 | +500 |
| games_100 | 百场老将 | 玩100场 | +200 |

---

### 测试5: API接口测试

#### 测试5.1: 获取玩家积分
```bash
curl http://localhost:3000/api/score/player_123
```

**预期响应**:
```json
{
  "success": true,
  "data": {
    "userId": "player_123",
    "username": "玩家A",
    "totalScore": 1034,
    "gamesPlayed": 3,
    "gamesWon": 3,
    "gamesLost": 0,
    "winRate": 100,
    "currentStreak": 3,
    "maxStreak": 3,
    ...
  }
}
```

#### 测试5.2: 获取排行榜
```bash
curl http://localhost:3000/api/score/leaderboard/score?limit=10
```

**预期响应**:
```json
{
  "success": true,
  "data": [
    {
      "rank": 1,
      "userId": "player_123",
      "username": "玩家A",
      "value": 1034,
      "gamesPlayed": 3,
      "winRate": 100
    },
    ...
  ]
}
```

#### 测试5.3: 获取玩家排名
```bash
curl http://localhost:3000/api/score/player_123/rank/score
```

**预期响应**:
```json
{
  "success": true,
  "data": {
    "userId": "player_123",
    "type": "score",
    "rank": 1
  }
}
```

#### 测试5.4: 获取玩家成就
```bash
curl http://localhost:3000/api/score/player_123/achievements
```

**预期响应**:
```json
{
  "success": true,
  "data": [
    {
      "id": "first_win",
      "name": "首胜",
      "description": "赢得第一场游戏",
      "icon": "🎉",
      "isUnlocked": true,
      "unlockedAt": "2025-10-30T06:56:00.000Z",
      "progress": 100
    },
    ...
  ]
}
```

---

### 测试6: 数据持久化

#### 步骤
1. 完成几局游戏
2. 重启后端服务器
3. 再次访问个人中心

#### 预期结果
- ✅ 数据文件自动创建：`backend/data/scores.json`
- ✅ 重启后数据保持不变
- ✅ 积分、战绩、成就都正确显示

#### 验证方法
查看数据文件：
```bash
cat backend/data/scores.json
```

---

### 测试7: 特殊场景测试

#### 场景7.1: 春天倍数
1. 地主获胜，农民未出牌
2. 查看积分变化

**预期**: 积分×2（春天倍数）

#### 场景7.2: 炸弹倍数
1. 游戏中出现炸弹
2. 查看积分变化

**预期**: 积分×2^n（n为炸弹数）

#### 场景7.3: 王炸倍数
1. 游戏中出现王炸
2. 查看积分变化

**预期**: 积分×4^n（n为王炸数）

#### 场景7.4: 组合倍数
1. 游戏中出现炸弹+王炸+春天
2. 查看积分变化

**预期**: 积分×(2^炸弹数 × 4^王炸数 × 2)

---

## 🐛 已知问题

### 问题1: TypeScript警告
**描述**: scoreRoutes.ts中有"并非所有代码路径都返回值"警告  
**影响**: 无，仅编译警告  
**状态**: 可忽略（Express路由中间件特性）

### 问题2: 首次访问个人中心
**描述**: 如果玩家从未游戏，个人中心会显示"玩家记录不存在"  
**解决**: 首次访问时自动创建初始记录（已实现）

---

## ✅ 测试检查清单

### 后端功能
- [ ] 积分正确记录
- [ ] 成就自动解锁
- [ ] 成就奖励积分发放
- [ ] 排行榜正确排序
- [ ] 数据持久化
- [ ] API接口正常响应
- [ ] 游戏结算集成

### 前端功能
- [ ] 个人中心页面加载
- [ ] 统计数据正确显示
- [ ] 排名信息显示
- [ ] 成就列表渲染
- [ ] 游戏历史显示
- [ ] 数字动画效果
- [ ] 响应式布局

### 边界情况
- [ ] 首次游戏
- [ ] 连续游戏
- [ ] 服务器重启
- [ ] 多玩家同时游戏
- [ ] 特殊倍数场景

---

## 📊 性能测试

### 测试指标
- 积分查询响应时间: < 100ms
- 排行榜加载时间: < 200ms
- 数据写入延迟: < 50ms
- 页面加载时间: < 1s

### 测试方法
使用浏览器开发者工具的Network标签查看请求时间。

---

## 🔧 调试技巧

### 查看后端日志
```bash
# 后端控制台会显示：
📊 玩家A 积分: +4 → 1004
🏆 玩家A 解锁成就: ['first_win']
💰 游戏得分: { baseScore: 1, ... }
```

### 查看数据文件
```bash
# 查看积分数据
cat backend/data/scores.json | jq .

# 查看玩家记录
cat backend/data/scores.json | jq '.players["player_123"]'
```

### 浏览器控制台
```javascript
// 查看localStorage
console.log(localStorage.getItem('userId'));
console.log(localStorage.getItem('playerName'));

// 手动调用API
fetch('/api/score/player_123')
  .then(r => r.json())
  .then(console.log);
```

---

## 🎯 下一步测试

1. **排行榜页面** - 创建并测试排行榜UI
2. **数据分析** - 测试统计图表功能
3. **性能测试** - 并发100+用户测试
4. **移动端** - 响应式布局测试

---

## 📝 测试报告模板

### 测试环境
- 操作系统: Windows 11
- 浏览器: Chrome 120
- Node.js: v18.x
- 后端端口: 3000

### 测试结果
| 测试项 | 状态 | 备注 |
|--------|------|------|
| 积分记录 | ✅ | 正常 |
| 成就解锁 | ✅ | 正常 |
| 排行榜 | ⏳ | 待测试 |
| 个人中心 | ✅ | 正常 |
| API接口 | ✅ | 正常 |

### 发现的问题
1. 问题描述
2. 重现步骤
3. 预期结果
4. 实际结果
5. 截图/日志

---

**测试完成后，请更新此文档并提交测试报告！** 📋

**创建时间**: 2025-10-30 06:56  
**版本**: v1.2.0
