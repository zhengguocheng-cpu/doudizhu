# 计分系统测试指南

## 🎯 计分系统概述

### 基础规则
- **基础分**: 1分
- **地主获胜**: 地主得分 = 基础分 × 倍数 × 2（从2个农民处赢得）
- **农民获胜**: 每个农民得分 = 基础分 × 倍数

### 倍数计算

| 类型 | 倍数 | 说明 |
|------|------|------|
| 炸弹 | ×2 | 每个炸弹×2，可叠加 |
| 王炸 | ×4 | 每个王炸×4，可叠加 |
| 春天 | ×2 | 地主获胜且农民一张牌都没出 |
| 反春 | ×2 | 农民获胜且地主一张牌都没出 |

**总倍数 = 基础 × 炸弹 × 王炸 × 春天 × 反春**

---

## 🧪 测试场景

### 场景1：基础得分（无倍数）

**条件**：
- 正常游戏，无炸弹、无王炸
- 地主或农民正常出完牌

**预期结果**：
- 基础分：1
- 倍数：×1
- 地主获胜：地主 +2，农民各 -1
- 农民获胜：地主 -2，农民各 +1

**测试步骤**：
1. 开始游戏
2. 正常出牌，避免出炸弹和王炸
3. 某方出完所有牌
4. 查看结算界面

**验证**：
```
✅ 倍数显示：×1
✅ 得分正确：±1或±2
✅ 无额外倍数说明
```

---

### 场景2：单个炸弹

**条件**：
- 游戏中出现1个炸弹（4张相同的牌）
- 无其他倍数

**预期结果**：
- 基础分：1
- 倍数：×2（炸弹×1）
- 地主获胜：地主 +4，农民各 -2
- 农民获胜：地主 -4，农民各 +2

**测试步骤**：
1. 开始游戏
2. 出1次炸弹（如：4个7）
3. 某方出完所有牌
4. 查看结算界面

**验证**：
```
✅ 倍数显示：×2 (炸弹×1)
✅ 得分正确：±2或±4
✅ 控制台显示：bombCount: 1
```

---

### 场景3：多个炸弹

**条件**：
- 游戏中出现2个炸弹
- 无其他倍数

**预期结果**：
- 基础分：1
- 倍数：×4（炸弹×2，2^2=4）
- 地主获胜：地主 +8，农民各 -4
- 农民获胜：地主 -8，农民各 +4

**测试步骤**：
1. 开始游戏
2. 出2次炸弹
3. 某方出完所有牌
4. 查看结算界面

**验证**：
```
✅ 倍数显示：×4 (炸弹×2)
✅ 得分正确：±4或±8
✅ 控制台显示：bombCount: 2
```

---

### 场景4：王炸

**条件**：
- 游戏中出现1个王炸（大王+小王）
- 无其他倍数

**预期结果**：
- 基础分：1
- 倍数：×4（王炸×1）
- 地主获胜：地主 +8，农民各 -4
- 农民获胜：地主 -8，农民各 +4

**测试步骤**：
1. 开始游戏
2. 出1次王炸
3. 某方出完所有牌
4. 查看结算界面

**验证**：
```
✅ 倍数显示：×4 (王炸×1)
✅ 得分正确：±4或±8
✅ 控制台显示：rocketCount: 1
```

---

### 场景5：炸弹+王炸

**条件**：
- 游戏中出现1个炸弹和1个王炸
- 无其他倍数

**预期结果**：
- 基础分：1
- 倍数：×8（炸弹×2 × 王炸×4 = 8）
- 地主获胜：地主 +16，农民各 -8
- 农民获胜：地主 -16，农民各 +8

**测试步骤**：
1. 开始游戏
2. 出1次炸弹和1次王炸
3. 某方出完所有牌
4. 查看结算界面

**验证**：
```
✅ 倍数显示：×8 (炸弹×1, 王炸×1)
✅ 得分正确：±8或±16
✅ 控制台显示：bombCount: 1, rocketCount: 1
```

---

### 场景6：春天

**条件**：
- 地主获胜
- 农民一张牌都没出过（手牌数=17）

**预期结果**：
- 基础分：1
- 倍数：×2（春天）
- 地主 +4，农民各 -2

**测试步骤**：
1. 开始游戏，地主拿到好牌
2. 地主连续出牌，农民一直不出
3. 地主出完所有牌
4. 查看结算界面

**验证**：
```
✅ 倍数显示：×2 (春天)
✅ 得分正确：地主+4，农民-2
✅ 控制台显示：isSpring: true
```

---

### 场景7：反春

**条件**：
- 农民获胜
- 地主一张牌都没出过（手牌数=20）

**预期结果**：
- 基础分：1
- 倍数：×2（反春）
- 地主 -4，农民各 +2

**测试步骤**：
1. 开始游戏，农民拿到好牌
2. 农民连续出牌，地主一直不出
3. 农民出完所有牌
4. 查看结算界面

**验证**：
```
✅ 倍数显示：×2 (反春)
✅ 得分正确：地主-4，农民+2
✅ 控制台显示：isAntiSpring: true
```

---

### 场景8：极限倍数

**条件**：
- 2个炸弹 + 1个王炸 + 春天
- 地主获胜

**预期结果**：
- 基础分：1
- 倍数：×32（炸弹×4 × 王炸×4 × 春天×2 = 32）
- 地主 +64，农民各 -32

**测试步骤**：
1. 开始游戏
2. 出2次炸弹和1次王炸
3. 地主出完所有牌，农民未出牌
4. 查看结算界面

**验证**：
```
✅ 倍数显示：×32 (炸弹×2, 王炸×1, 春天)
✅ 得分正确：地主+64，农民-32
✅ 控制台显示完整得分信息
```

---

## 🔍 调试方法

### 查看详细得分

打开浏览器控制台（F12），查看日志：

```javascript
// 游戏结束时会输出
💰 [结算] 详细得分: {
  baseScore: 1,
  bombCount: 2,
  rocketCount: 1,
  isSpring: false,
  isAntiSpring: false,
  landlordWin: true,
  playerScores: [...]
}

// 每个玩家的得分
   玩家A (landlord): +16
   玩家B (farmer): -8
   玩家C (farmer): -8
```

### 手动测试计分

在控制台运行：

```javascript
// 查看游戏历史
console.log('出牌历史:', room.gameState.playHistory);

// 查看玩家手牌数
room.players.forEach(p => {
  console.log(`${p.name}: ${p.cardCount}张牌`);
});
```

---

## 📊 结算界面说明

### 显示内容

```
🎊 地主获胜！ / 农民获胜！

👑 获胜者
玩家名字
角色（地主/农民）

💰 得分详情
基础分：1
倍数：×8 (炸弹×1, 王炸×1)
总得分：+8 / -8
```

### 颜色编码

- **绿色** (+分数): 获胜方得分
- **红色** (-分数): 失败方失分

---

## 🐛 常见问题

### Q1: 倍数计算不正确？

**检查**：
1. 查看控制台的 `bombCount` 和 `rocketCount`
2. 确认出牌历史是否正确记录
3. 检查牌型识别是否正确

**解决**：
```javascript
// 查看出牌历史
console.log(room.gameState.playHistory);

// 查看每次出牌的牌型
playHistory.forEach(play => {
  console.log(play.cardType.type);
});
```

---

### Q2: 春天/反春判断错误？

**检查**：
1. 查看玩家手牌数
2. 农民初始17张，地主初始20张
3. 确认是否真的一张牌都没出

**解决**：
```javascript
// 查看玩家手牌数
room.players.forEach(p => {
  console.log(`${p.name} (${p.role}): ${p.cardCount}张`);
});
```

---

### Q3: 得分显示为NaN？

**检查**：
1. 后端是否正确返回 `score` 对象
2. 前端是否正确解析 `score` 数据

**解决**：
```javascript
// 查看完整的game_over数据
socket.on('game_over', (data) => {
  console.log('完整数据:', data);
  console.log('得分对象:', data.score);
});
```

---

## ✅ 验收标准

### 功能完整性
- [x] 基础得分计算
- [x] 炸弹倍数（×2^n）
- [x] 王炸倍数（×4^n）
- [x] 春天倍数（×2）
- [x] 反春倍数（×2）
- [x] 倍数叠加计算
- [x] 个人得分计算

### 界面显示
- [x] 基础分显示
- [x] 倍数显示
- [x] 倍数说明（炸弹、王炸等）
- [x] 总得分显示
- [x] 得分颜色编码
- [x] 控制台详细日志

### 准确性
- [x] 地主获胜得分正确
- [x] 农民获胜得分正确
- [x] 炸弹倍数正确
- [x] 王炸倍数正确
- [x] 春天判断正确
- [x] 反春判断正确

---

## 📝 测试记录模板

```markdown
### 测试日期：2025-10-29
### 测试人员：[你的名字]

#### 测试结果

| 场景 | 预期倍数 | 实际倍数 | 预期得分 | 实际得分 | 状态 |
|------|---------|---------|---------|---------|------|
| 基础得分 | ×1 | ×1 | ±1/±2 | ±1/±2 | ✅ |
| 单个炸弹 | ×2 | ×2 | ±2/±4 | ±2/±4 | ✅ |
| 王炸 | ×4 | ×4 | ±4/±8 | ±4/±8 | ✅ |
| 春天 | ×2 | ×2 | +4/-2 | +4/-2 | ✅ |

#### 问题记录
1. [描述问题]
2. [描述问题]

#### 建议
1. [改进建议]
2. [改进建议]
```

---

**创建时间**: 2025-10-29  
**最后更新**: 2025-10-29  
**版本**: v1.1.0
