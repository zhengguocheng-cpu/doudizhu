<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸¸æˆæµç¨‹æµ‹è¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .players {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        .player-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .player-panel h2 {
            margin-top: 0;
            color: #2196F3;
        }
        .player-panel.player1 h2 { color: #f44336; }
        .player-panel.player2 h2 { color: #4CAF50; }
        .player-panel.player3 h2 { color: #FF9800; }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-size: 14px;
        }
        .status.connected { background: #E8F5E9; color: #2E7D32; }
        .status.disconnected { background: #FFEBEE; color: #C62828; }
        .status.waiting { background: #FFF3E0; color: #E65100; }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            background: #2196F3;
            color: white;
        }
        button:hover {
            background: #1976D2;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .log {
            background: #263238;
            color: #00FF00;
            padding: 15px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin-top: 10px;
        }
        .log-entry {
            margin: 2px 0;
        }
        .log-entry.error { color: #FF5252; }
        .log-entry.success { color: #69F0AE; }
        .log-entry.info { color: #00E5FF; }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .room-info {
            background: #E3F2FD;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® æ–—åœ°ä¸»æ¸¸æˆæµç¨‹æµ‹è¯•å·¥å…·</h1>
        
        <div class="controls">
            <h3>æµ‹è¯•æ§åˆ¶</h3>
            <button onclick="testPhase1()">é˜¶æ®µ1: ä¸‰äººç™»å½•</button>
            <button onclick="testPhase2()">é˜¶æ®µ2: è¿›å…¥å¤§å…</button>
            <button onclick="testPhase3()">é˜¶æ®µ3: åŠ å…¥æˆ¿é—´A01</button>
            <button onclick="testPhase4()">é˜¶æ®µ4: å…¨éƒ¨å‡†å¤‡</button>
            <button onclick="testPhase5()">é˜¶æ®µ5: å¼€å§‹æ¸¸æˆ</button>
            <button onclick="testPhase6()">é˜¶æ®µ6: æŠ¢åœ°ä¸»</button>
            <button onclick="resetAll()">é‡ç½®æ‰€æœ‰</button>
        </div>
        
        <div class="players">
            <div class="player-panel player1">
                <h2>ğŸ‘‘ Player1</h2>
                <div id="status1" class="status disconnected">æœªè¿æ¥</div>
                <div class="room-info" id="room1">æˆ¿é—´: -</div>
                <button onclick="connectPlayer(1)">è¿æ¥</button>
                <button onclick="joinRoom(1, 'A01')">åŠ å…¥A01</button>
                <button onclick="ready(1)">å‡†å¤‡</button>
                <button onclick="bidLandlord(1, true)" style="background: #4CAF50;">æŠ¢åœ°ä¸»</button>
                <button onclick="bidLandlord(1, false)" style="background: #f44336;">ä¸æŠ¢</button>
                <div class="log" id="log1"></div>
            </div>
            
            <div class="player-panel player2">
                <h2>ğŸ¯ Player2</h2>
                <div id="status2" class="status disconnected">æœªè¿æ¥</div>
                <div class="room-info" id="room2">æˆ¿é—´: -</div>
                <button onclick="connectPlayer(2)">è¿æ¥</button>
                <button onclick="joinRoom(2, 'A01')">åŠ å…¥A01</button>
                <button onclick="ready(2)">å‡†å¤‡</button>
                <button onclick="bidLandlord(2, true)" style="background: #4CAF50;">æŠ¢åœ°ä¸»</button>
                <button onclick="bidLandlord(2, false)" style="background: #f44336;">ä¸æŠ¢</button>
                <div class="log" id="log2"></div>
            </div>
            
            <div class="player-panel player3">
                <h2>ğŸ”¥ Player3</h2>
                <div id="status3" class="status disconnected">æœªè¿æ¥</div>
                <div class="room-info" id="room3">æˆ¿é—´: -</div>
                <button onclick="connectPlayer(3)">è¿æ¥</button>
                <button onclick="joinRoom(3, 'A01')">åŠ å…¥A01</button>
                <button onclick="ready(3)">å‡†å¤‡</button>
                <button onclick="bidLandlord(3, true)" style="background: #4CAF50;">æŠ¢åœ°ä¸»</button>
                <button onclick="bidLandlord(3, false)" style="background: #f44336;">ä¸æŠ¢</button>
                <div class="log" id="log3"></div>
            </div>
        </div>
    </div>

    <!-- Socket.IOå®¢æˆ·ç«¯åº“ - ä½¿ç”¨æœ¬åœ°æ–‡ä»¶ -->
    <script src="/socket.io.min.js" 
            onerror="handleSocketIOLoadError()"></script>
    
    <script>
        // Socket.IOåŠ è½½é”™è¯¯å¤„ç†
        function handleSocketIOLoadError() {
            console.error('âŒ Socket.IO CDNåŠ è½½å¤±è´¥');
            document.body.innerHTML = `
                <div style="text-align: center; padding: 50px; font-family: Arial;">
                    <h1 style="color: #f44336;">âŒ Socket.IOåº“åŠ è½½å¤±è´¥</h1>
                    <p style="font-size: 18px; color: #666;">æ— æ³•ä»CDNåŠ è½½Socket.IOå®¢æˆ·ç«¯åº“</p>
                    <div style="text-align: left; max-width: 600px; margin: 30px auto; background: #f5f5f5; padding: 20px; border-radius: 8px;">
                        <h3>å¯èƒ½åŸå› ï¼š</h3>
                        <ul>
                            <li>ç½‘ç»œè¿æ¥é—®é¢˜</li>
                            <li>CDNæœåŠ¡ä¸å¯ç”¨</li>
                            <li>é˜²ç«å¢™æˆ–ä»£ç†é˜»æ­¢</li>
                        </ul>
                        <h3>è§£å†³æ–¹æ¡ˆï¼š</h3>
                        <ol>
                            <li>æ£€æŸ¥ç½‘ç»œè¿æ¥</li>
                            <li>åˆ·æ–°é¡µé¢é‡è¯• (Ctrl + F5)</li>
                            <li>å°è¯•ä½¿ç”¨VPN</li>
                            <li>è”ç³»ç®¡ç†å‘˜æ£€æŸ¥ç½‘ç»œè®¾ç½®</li>
                        </ol>
                    </div>
                    <button onclick="location.reload()" 
                            style="padding: 15px 30px; font-size: 16px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ğŸ”„ é‡æ–°åŠ è½½é¡µé¢
                    </button>
                </div>
            `;
        }

        // æ£€æŸ¥Socket.IOæ˜¯å¦åŠ è½½æˆåŠŸ
        if (typeof io === 'undefined') {
            console.error('âŒ Socket.IOåº“æœªå®šä¹‰');
            handleSocketIOLoadError();
        } else {
            console.log('âœ… Socket.IOåº“åŠ è½½æˆåŠŸï¼Œç‰ˆæœ¬:', io.version);
        }

        const players = {
            1: { socket: null, name: 'player1', avatar: 'ğŸ‘‘', room: null },
            2: { socket: null, name: 'player2', avatar: 'ğŸ¯', room: null },
            3: { socket: null, name: 'player3', avatar: 'ğŸ”¥', room: null }
        };

        function log(playerId, message, type = 'info') {
            const logDiv = document.getElementById(`log${playerId}`);
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(playerId, status, className) {
            const statusDiv = document.getElementById(`status${playerId}`);
            statusDiv.textContent = status;
            statusDiv.className = `status ${className}`;
        }

        function updateRoom(playerId, roomId) {
            const roomDiv = document.getElementById(`room${playerId}`);
            roomDiv.textContent = `æˆ¿é—´: ${roomId || '-'}`;
            players[playerId].room = roomId;
        }

        function connectPlayer(playerId) {
            const player = players[playerId];
            
            if (player.socket && player.socket.connected) {
                log(playerId, 'å·²ç»è¿æ¥', 'info');
                return;
            }

            log(playerId, `å¼€å§‹è¿æ¥... ç”¨æˆ·å: ${player.name}`, 'info');
            updateStatus(playerId, 'è¿æ¥ä¸­...', 'waiting');
            
            try {
                player.socket = io('http://localhost:3000', {
                    auth: {
                        userId: player.name,
                        userName: player.name
                    },
                    reconnection: true,
                    reconnectionDelay: 1000,
                    reconnectionAttempts: 5,
                    timeout: 10000
                });

                // è¿æ¥è¶…æ—¶æ£€æµ‹
                const connectTimeout = setTimeout(() => {
                    if (!player.socket || !player.socket.connected) {
                        log(playerId, 'âŒ è¿æ¥è¶…æ—¶ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ', 'error');
                        updateStatus(playerId, 'è¿æ¥è¶…æ—¶', 'disconnected');
                    }
                }, 10000);

                player.socket.on('connect', () => {
                    clearTimeout(connectTimeout);
                    log(playerId, `âœ… Socketè¿æ¥æˆåŠŸ! ID: ${player.socket.id}`, 'success');
                    updateStatus(playerId, 'å·²è¿æ¥', 'connected');
                });

                player.socket.on('connect_error', (error) => {
                    clearTimeout(connectTimeout);
                    log(playerId, `âŒ è¿æ¥é”™è¯¯: ${error.message}`, 'error');
                    updateStatus(playerId, 'è¿æ¥å¤±è´¥', 'disconnected');
                });

            player.socket.on('disconnect', (reason) => {
                log(playerId, `âŒ æ–­å¼€è¿æ¥: ${reason}`, 'error');
                updateStatus(playerId, 'æœªè¿æ¥', 'disconnected');
            });

            player.socket.on('error', (error) => {
                const errorMsg = error?.message || JSON.stringify(error) || 'æœªçŸ¥é”™è¯¯';
                log(playerId, `âŒ é”™è¯¯: ${errorMsg}`, 'error');
                console.error('Socketé”™è¯¯è¯¦æƒ…:', error);
            });

            // æˆ¿é—´ç›¸å…³äº‹ä»¶
            player.socket.on('join_game_success', (data) => {
                log(playerId, `âœ… åŠ å…¥æˆ¿é—´æˆåŠŸ: ${data.roomId}`, 'success');
                updateRoom(playerId, data.roomId);
                updateStatus(playerId, 'åœ¨æˆ¿é—´ä¸­', 'waiting');
            });

            player.socket.on('join_game_failed', (data) => {
                log(playerId, `âŒ åŠ å…¥æˆ¿é—´å¤±è´¥: ${data.message}`, 'error');
            });

            player.socket.on('player_joined', (data) => {
                log(playerId, `ğŸ‘¤ ç©å®¶åŠ å…¥: ${data.playerName}`, 'info');
            });

            player.socket.on('player_ready', (data) => {
                log(playerId, `âœ… ç©å®¶å‡†å¤‡: ${data.playerName}`, 'success');
            });

            player.socket.on('game_started', (data) => {
                log(playerId, `ğŸ® æ¸¸æˆå¼€å§‹! æˆ¿é—´: ${data.roomId}`, 'success');
            });

            player.socket.on('deal_cards', (data) => {
                log(playerId, `ğŸ´ æ”¶åˆ°ç‰Œ: ${data.cards.length}å¼ `, 'success');
                log(playerId, `åº•ç‰Œ: ${data.bottomCards ? data.bottomCards.length : 0}å¼ `, 'info');
                // ä¿å­˜ç©å®¶çš„ç‰Œ
                player.cards = data.cards;
            });

            // æŠ¢åœ°ä¸»ç›¸å…³äº‹ä»¶
            player.socket.on('bidding_start', (data) => {
                log(playerId, `ğŸ² å¼€å§‹æŠ¢åœ°ä¸»! ç¬¬ä¸€ä¸ªç©å®¶: ${data.firstBidderName}`, 'success');
                log(playerId, `åº•ç‰Œ: ${data.bottomCards.join(', ')}`, 'info');
                player.currentBidderId = data.firstBidderId;
            });

            player.socket.on('bid_result', (data) => {
                const bidText = data.bid ? 'æŠ¢' : 'ä¸æŠ¢';
                log(playerId, `ğŸ² ${data.userName} é€‰æ‹©: ${bidText}`, 'info');
                if (data.nextBidderId) {
                    log(playerId, `ä¸‹ä¸€ä¸ª: ${data.nextBidderId}`, 'info');
                    player.currentBidderId = data.nextBidderId;
                }
            });

            player.socket.on('landlord_determined', (data) => {
                log(playerId, `ğŸ‘‘ åœ°ä¸»ç¡®å®š: ${data.landlordName}`, 'success');
                log(playerId, `åº•ç‰Œ: ${data.bottomCards.join(', ')}`, 'info');
                const role = data.roles[player.name];
                log(playerId, `ä½ çš„è§’è‰²: ${role === 'landlord' ? 'åœ°ä¸»' : 'å†œæ°‘'}`, role === 'landlord' ? 'success' : 'info');
                player.role = role;
            });

            player.socket.on('landlord_cards_update', (data) => {
                log(playerId, `ğŸ‘‘ åœ°ä¸»è·å¾—åº•ç‰Œï¼Œç°åœ¨æœ‰ ${data.cardCount} å¼ ç‰Œ`, 'success');
                player.cards = data.cards;
            });

            player.socket.on('turn_to_play', (data) => {
                log(playerId, `ğŸ¯ è½®åˆ° ${data.playerName} å‡ºç‰Œ`, 'info');
            });

            player.socket.on('no_landlord', (data) => {
                log(playerId, `âŒ ${data.message}`, 'error');
            });
            
            } catch (error) {
                log(playerId, `âŒ åˆå§‹åŒ–è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                updateStatus(playerId, 'åˆå§‹åŒ–å¤±è´¥', 'disconnected');
            }
        }

        function joinRoom(playerId, roomId) {
            const player = players[playerId];
            
            if (!player.socket || !player.socket.connected) {
                log(playerId, 'âŒ è¯·å…ˆè¿æ¥', 'error');
                return;
            }

            log(playerId, `å°è¯•åŠ å…¥æˆ¿é—´: ${roomId}`, 'info');
            player.socket.emit('join_game', {
                roomId: roomId,
                userId: player.name,
                playerName: player.name,
                playerAvatar: player.avatar
            });
        }

        function ready(playerId) {
            const player = players[playerId];
            
            if (!player.socket || !player.socket.connected) {
                log(playerId, 'âŒ è¯·å…ˆè¿æ¥', 'error');
                return;
            }

            if (!player.room) {
                log(playerId, 'âŒ è¯·å…ˆåŠ å…¥æˆ¿é—´', 'error');
                return;
            }

            log(playerId, 'å‘é€å‡†å¤‡ä¿¡å·...', 'info');
            player.socket.emit('player_ready', {
                roomId: player.room,
                userId: player.name
            });
        }

        function bidLandlord(playerId, bid) {
            const player = players[playerId];
            
            if (!player.socket || !player.socket.connected) {
                log(playerId, 'âŒ è¯·å…ˆè¿æ¥', 'error');
                return;
            }

            if (!player.room) {
                log(playerId, 'âŒ è¯·å…ˆåŠ å…¥æˆ¿é—´', 'error');
                return;
            }

            const bidText = bid ? 'æŠ¢åœ°ä¸»' : 'ä¸æŠ¢';
            log(playerId, `å‘é€æŠ¢åœ°ä¸»å†³å®š: ${bidText}`, 'info');
            player.socket.emit('bid_landlord', {
                roomId: player.room,
                userId: player.name,
                bid: bid
            });
        }

        // æµ‹è¯•é˜¶æ®µ
        async function testPhase1() {
            console.log('ğŸ¯ å¼€å§‹é˜¶æ®µ1: ä¸‰äººç™»å½•');
            connectPlayer(1);
            await sleep(1000);
            connectPlayer(2);
            await sleep(1000);
            connectPlayer(3);
        }

        async function testPhase2() {
            console.log('ğŸ¯ å¼€å§‹é˜¶æ®µ2: è¿›å…¥å¤§å…ï¼ˆå·²åœ¨ç™»å½•æ—¶å®Œæˆï¼‰');
        }

        async function testPhase3() {
            console.log('ğŸ¯ å¼€å§‹é˜¶æ®µ3: åŠ å…¥æˆ¿é—´A01');
            joinRoom(1, 'A01');
            await sleep(1000);
            joinRoom(2, 'A01');
            await sleep(1000);
            joinRoom(3, 'A01');
        }

        async function testPhase4() {
            console.log('ğŸ¯ å¼€å§‹é˜¶æ®µ4: å…¨éƒ¨å‡†å¤‡');
            ready(1);
            await sleep(500);
            ready(2);
            await sleep(500);
            ready(3);
        }

        async function testPhase5() {
            console.log('ğŸ¯ å¼€å§‹é˜¶æ®µ5: å¼€å§‹æ¸¸æˆ');
            // æ¸¸æˆåº”è¯¥åœ¨3äººå‡†å¤‡åè‡ªåŠ¨å¼€å§‹
        }

        async function testPhase6() {
            console.log('ğŸ¯ å¼€å§‹é˜¶æ®µ6: æŠ¢åœ°ä¸»');
            // ç­‰å¾…æŠ¢åœ°ä¸»å¼€å§‹
            await sleep(3000);
            
            // æ¨¡æ‹ŸæŠ¢åœ°ä¸»ï¼šç¬¬ä¸€ä¸ªç©å®¶æŠ¢ï¼Œç¬¬äºŒä¸ªä¸æŠ¢ï¼Œç¬¬ä¸‰ä¸ªä¸æŠ¢
            // æ³¨æ„ï¼šéœ€è¦æ ¹æ®å®é™…çš„ç¬¬ä¸€ä¸ªæŠ¢åœ°ä¸»ç©å®¶æ¥å†³å®š
            // è¿™é‡Œç®€å•æ¨¡æ‹Ÿï¼šplayer1æŠ¢ï¼Œå…¶ä»–ä¸æŠ¢
            console.log('ğŸ² Player1 æŠ¢åœ°ä¸»');
            bidLandlord(1, true);
            await sleep(1000);
            
            console.log('ğŸ² Player2 ä¸æŠ¢');
            bidLandlord(2, false);
            await sleep(1000);
            
            console.log('ğŸ² Player3 ä¸æŠ¢');
            bidLandlord(3, false);
        }

        function resetAll() {
            for (let i = 1; i <= 3; i++) {
                if (players[i].socket) {
                    players[i].socket.disconnect();
                }
                players[i].socket = null;
                players[i].room = null;
                updateStatus(i, 'æœªè¿æ¥', 'disconnected');
                updateRoom(i, null);
                document.getElementById(`log${i}`).innerHTML = '';
            }
            console.log('ğŸ”„ å·²é‡ç½®æ‰€æœ‰ç©å®¶');
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„æç¤º
        window.onload = function() {
            console.log('ğŸ® æ¸¸æˆæµç¨‹æµ‹è¯•å·¥å…·å·²åŠ è½½');
            console.log('ğŸ“ ä½¿ç”¨é¡¶éƒ¨æŒ‰é’®è¿›è¡Œåˆ†é˜¶æ®µæµ‹è¯•');
            console.log('ğŸ“ æˆ–ä½¿ç”¨å•ä¸ªç©å®¶çš„æŒ‰é’®è¿›è¡Œæ‰‹åŠ¨æµ‹è¯•');
            console.log('ğŸ’¡ æç¤ºï¼šç‚¹å‡»"é˜¶æ®µ1: ä¸‰äººç™»å½•"å¼€å§‹æµ‹è¯•');
        };
    </script>
</body>
</html>
